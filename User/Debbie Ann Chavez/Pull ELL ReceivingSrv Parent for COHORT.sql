
EXECUTE AS LOGIN='QueryFileUser'
GO


SELECT 
	T1.*
	,ELL_ENTRY_DATE
	,ELL_EXIT_DATE
	,[ELL 2011-2012]
	,[ELL 2012-2013]
	,[ELL 2013-2014]
	,[ELL 2014-2015]
	
	FROM
            OPENROWSET (
                  'Microsoft.ACE.OLEDB.12.0', 
                 'Text;Database=\\SYNTEMPSSIS\Files\TempQuery;',
                  'SELECT * from Unduplicated.csv'
                ) AS [T1]

LEFT JOIN 
(SELECT 
		STATE_STUDENT_NUMBER
		, ENTRY_DATE AS ELL_ENTRY_DATE
		, EXIT_DATE AS ELL_EXIT_DATE
,CASE 
WHEN EXIT_DATE IS NULL AND (ENTRY_DATE >= '2014-07-01' AND ENTRY_DATE <= '2015-06-30') THEN  'Y'
WHEN EXIT_DATE IS NULL AND ENTRY_DATE < '2015-06-30' THEN 'Y'
WHEN EXIT_DATE > '2014-07-01' AND ENTRY_DATE <= '2015-06-30'  THEN 'Y'
ELSE NULL END AS [ELL 2014-2015]

,CASE 
WHEN EXIT_DATE IS NULL AND (ENTRY_DATE >= '2013-07-01' AND ENTRY_DATE <= '2014-06-30')THEN  'Y' 
WHEN EXIT_DATE IS NULL AND ENTRY_DATE < '2014-06-30' THEN 'Y'
WHEN EXIT_DATE > '2013-07-01' AND ENTRY_DATE <= '2014-06-30' THEN 'Y'
ELSE NULL END AS [ELL 2013-2014]

,CASE 
WHEN EXIT_DATE IS NULL AND (ENTRY_DATE >= '2012-07-01' AND ENTRY_DATE <= '2013-06-30') THEN  'Y' 
WHEN EXIT_DATE IS NULL AND ENTRY_DATE < '2013-06-30' THEN 'Y'
WHEN EXIT_DATE > '2012-07-01' AND ENTRY_DATE <= '2013-06-30' THEN 'Y'

ELSE NULL END AS [ELL 2012-2013]

,CASE 
WHEN EXIT_DATE IS NULL AND (ENTRY_DATE >= '2011-07-01' AND ENTRY_DATE <= '2012-06-30') THEN  'Y'
WHEN EXIT_DATE IS NULL AND ENTRY_DATE < '2012-06-30' THEN 'Y'
WHEN EXIT_DATE > '2011-07-01' AND ENTRY_DATE <= '2012-06-30' THEN 'Y'

ELSE NULL END AS [ELL 2011-2012]

FROM 
	
(
SELECT 
STATE_STUDENT_NUMBER, MAX(CAST(history.ENTRY_DATE AS DATE)) AS ENTRY_DATE
, MAX(CAST(EXIT_DATE AS DATE)) AS EXIT_DATE
FROM
rev.EPC_STU_PGM_ELL_HIS AS History
INNER JOIN 
rev.EPC_STU AS STU
ON
History.STUDENT_GU = STU.STUDENT_GU
GROUP BY STATE_STUDENT_NUMBER
) AS ELL
) AS ELLCOMBO
ON
ELLCOMBO.STATE_STUDENT_NUMBER = T1.StudentID


/*
LEFT JOIN 
(SELECT DISTINCT STATE_STUDENT_NUMBER, WAIVER_TYPE FROM 
	APS.LCEMostRecentALSRefusalAsOf ('2016-05-25') AS PARENTREFUSAL
INNER JOIN 
rev.EPC_STU AS STU
ON
PARENTREFUSAL.STUDENT_GU = STU.STUDENT_GU
) AS PR
ON
PR.STATE_STUDENT_NUMBER = T1.StudentID
*/


REVERT
GO