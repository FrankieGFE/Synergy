
SELECT 
	CLUSTERNAME.ORGANIZATION_NAME AS CLUSTER_NAME, ORG.ORGANIZATION_NAME, SIS_NUMBER, T1.GRADE, TEST_NAME, PERFORMANCE_LEVEL

 FROM 


	(SELECT 
			*
	FROM 

	(
	SELECT 
			ESL.*
			,STU.STUDENT_GU 
			,ROW_NUMBER() OVER (PARTITION BY ESL.SIS_NUMBER ORDER BY STATUS DESC) AS RN
	 FROM 
	APS.LCEStudentsAndProvidersAsOf('2015-05-22') AS ESL
	INNER JOIN
	rev.EPC_STU AS STU
	ON
	ESL.SIS_NUMBER = STU.SIS_NUMBER

	) AS T1
	WHERE RN =1
	AND GRADE NOT IN ('P1', 'P2', 'PK', 'T1', 'T2', 'T3', 'T4', 'C1', 'C2', 'C3', 'C4')

	) AS T1


INNER JOIN
APS.PrimaryEnrollmentsAsOf('2015-05-22')AS PE
	
ON
T1.STUDENT_GU = PE.STUDENT_GU

INNER JOIN
rev.REV_ORGANIZATION_YEAR AS ORGYR
ON
PE.ORGANIZATION_YEAR_GU = ORGYR.ORGANIZATION_YEAR_GU
INNER JOIN
rev.REV_ORGANIZATION AS ORG
ON
ORGYR.ORGANIZATION_GU = ORG.ORGANIZATION_GU
INNER JOIN
rev.EPC_SCH AS SCHOOL
ON
SCHOOL.ORGANIZATION_GU = ORG.ORGANIZATION_GU

------------------------------------------------
INNER JOIN
rev.EPC_SCH AS CLUSTER
ON
SCHOOL.ALT_FUNDING_SCHOOL_CODE = CLUSTER.SCHOOL_CODE

INNER JOIN
rev.REV_ORGANIZATION AS CLUSTERNAME
ON
CLUSTER.ORGANIZATION_GU = CLUSTERNAME.ORGANIZATION_GU


WHERE
	CLUSTER.ALT_FUNDING_SCHOOL_CODE = '570'

	ORDER BY ORG.ORGANIZATION_NAME, GRADE, SIS_NUMBER