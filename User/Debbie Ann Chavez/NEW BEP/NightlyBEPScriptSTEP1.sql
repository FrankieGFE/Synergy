




/**************************************************************

--MAKE THIS STEP 1

-- CLOSE OUT RECORDS WHERE THE MODEL AND HOURS MATCH

**************************************************************/

BEGIN TRAN

UPDATE REV.EPC_STU_PGM_ELL_BEP 
	SET EXIT_DATE =  EXITDATE 
	, [CHANGE_ID_STAMP] = '27CDCD0E-BF93-4071-94B2-5DB792BB735F', [CHANGE_DATE_TIME_STAMP] = GETDATE()

FROM 
(

SELECT 
	T1.SIS_NUMBER
	,T1.STUDENT_GU
	,T1.PROGRAM_CODE AS PROGRAMCODE
	,T1.PROGRAM_INTENSITY AS PROGRAMINTENSITY
	,T1.ENTER_DATE AS ENTERDATE
	,T1.EXIT_DATE AS EXITDATE

	,BEP2.PROGRAM_CODE
	,BEP2.PROGRAM_INTENSITY
	,BEP2.ENTER_DATE
	,BEP2.EXIT_DATE
	,BEP2.STU_PGM_ELL_BEP_GU

 FROM 	
(
SELECT 

	STU.STUDENT_GU 
	,STU.SIS_NUMBER
	,MAX(SCH.COURSE_ENTER_DATE) AS ENTER_DATE
	,LU.VALUE_CODE AS PROGRAM_CODE
	,BEP.[HOUR] AS PROGRAM_INTENSITY
	,SCH.COURSE_LEAVE_DATE AS EXIT_DATE

 FROM 
	APS.NewBEPStudentsModelsAndHoursAsOf(GETDATE()) AS BEP
	INNER JOIN 
	REV.EPC_STU AS STU
	ON
	BEP.SIS_NUMBER = STU.SIS_NUMBER
	INNER HASH JOIN 
	APS.NewBEPModelsAndHoursDetailsAsOf(GETDATE()) AS MODELS
	ON
	BEP.SIS_NUMBER = MODELS.SIS_NUMBER
	INNER HASH JOIN 
	APS.ScheduleDetailsAsOf(GETDATE()) AS SCH
	ON
	SCH.SIS_NUMBER = MODELS.SIS_NUMBER
	AND SCH.ORGANIZATION_NAME = MODELS.SCHOOL_NAME
	AND SCH.COURSE_ID = MODELS.COURSE_ID
	AND SCH.SECTION_ID = MODELS.SECTION_ID
	INNER JOIN 
	APS.LookupTable ('K12.ProgramInfo', 'BEP_PROGRAM_CODE') AS LU
	ON
	LU.VALUE_DESCRIPTION = BEP.MODEL

GROUP BY STU.STUDENT_GU, STU.SIS_NUMBER, BEP.[HOUR], BEP.MODEL, VALUE_CODE, COURSE_LEAVE_DATE

) AS T1

LEFT HASH JOIN 
(SELECT * FROM REV.EPC_STU_PGM_ELL_BEP WHERE ENTER_DATE > '20170701') AS BEP2
ON
BEP2.STUDENT_GU = T1.STUDENT_GU

WHERE 
	BEP2.STUDENT_GU = T1.STUDENT_GU
	AND COALESCE(BEP2.PROGRAM_CODE, '') = T1.PROGRAM_CODE
	AND COALESCE(BEP2.PROGRAM_INTENSITY, '') = T1.PROGRAM_INTENSITY
	--EXISTING RECORDS TO CLOSE OUT
	AND COALESCE(BEP2.EXIT_DATE, '') != T1.EXIT_DATE

) AS UPDATEALLOFTHIS

WHERE

REV.EPC_STU_PGM_ELL_BEP.STU_PGM_ELL_BEP_GU = UPDATEALLOFTHIS.STU_PGM_ELL_BEP_GU

COMMIT