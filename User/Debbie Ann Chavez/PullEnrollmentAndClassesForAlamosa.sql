
SELECT DISTINCT 
CASE WHEN ELL.STUDENT_GU IS NOT NULL THEN 'Y' ELSE 'N' END AS EVER_ELL
, STU.SIS_NUMBER, ENR.GRADE, SCHOOL_CODE, SCHOOL_NAME, ENTER_DATE, ENTER_DESCRIPTION, LEAVE_DATE, LEAVE_DESCRIPTION
,SUMMER_WITHDRAWL_CODE

,COURSE_ID
,SECTION_ID
,COURSE_TITLE
,COURSE_ENTER_DATE
,COURSE_LEAVE_DATE
,TCH_LAST_NAME
,TCH_FIRST_NAME
,CASE WHEN AUTHORIZED_TCH_AREA = '67' THEN 'Bilingual' ELSE '' END AS BIL_ENDORSED
,CASE WHEN AUTHORIZED_TCH_AREA = '27' THEN 'TESOL' ELSE '' END AS TESOL_ENDORSED

,TEST_NAME
,PART_DESCRIPTION
,SCORE_DESCRIPTION
,PERFORMANCE_LEVEL
,TEST_SCORE
,CAST (ADMIN_DATE AS DATE) AS DATES


 FROM 
APS.StudentEnrollmentDetails AS ENR
INNER JOIN
rev.EPC_STU AS STU
ON
ENR.STUDENT_GU = STU.STUDENT_GU
INNER JOIN 
APS.LCEEverELLStudentAsOf('2015-05-22') AS ELL
ON 
ELL.STUDENT_GU = STU.STUDENT_GU

INNER JOIN 
(SELECT 
	ORGANIZATION_NAME
	,SIS_NUMBER
	,[COURSE].COURSE_ID
	,SCHEDULE.SECTION_ID
	,[COURSE].COURSE_TITLE
	,COURSE_ENTER_DATE
	,COURSE_LEAVE_DATE
	,SCHEDULE.STUDENT_GU
	,STAFF.STAFF_GU
	,[STAFF_PERSON].LAST_NAME AS TCH_LAST_NAME
	,[STAFF_PERSON].FIRST_NAME AS TCH_FIRST_NAME
	,AUTHORIZED_TCH_AREA
 FROM 

	APS.BasicSchedule AS SCHEDULE
	INNER JOIN
	APS.SectionsAndAllTags AS TAGS
	ON
	SCHEDULE.SECTION_GU = TAGS.SECTION_GU
	AND TAGS.ALSES IS NOT NULL

	INNER JOIN
	rev.EPC_CRS AS CourseMaster
	ON
	SCHEDULE.COURSE_GU = CourseMaster.COURSE_GU
	INNER JOIN
	rev.REV_ORGANIZATION AS ORG
	ON
	SCHEDULE.ORGANIZATION_GU = ORG.ORGANIZATION_GU
	INNER JOIN
	rev.EPC_STU AS STU
	ON
	STU.STUDENT_GU = SCHEDULE.STUDENT_GU

	INNER JOIN
	rev.EPC_CRS AS [COURSE]
	ON
	[SCHEDULE].[COURSE_GU] = [COURSE].[COURSE_GU]
	
	-- Get both primary and secodary staff
	INNER JOIN
	(
	SELECT
		[STAFF_SCHOOL_YEAR_GU]
		,[STAFF_GU]
		,[ORGANIZATION_YEAR_GU]
		,1 AS [PRIMARY_STAFF]
	FROM
		rev.[EPC_STAFF_SCH_YR] AS [STAFF_SCHOOL_YEAR]
		
	UNION ALL
		
	SELECT
		[STAFF_SCHOOL_YEAR].[STAFF_SCHOOL_YEAR_GU]
		,[STAFF_SCHOOL_YEAR].[STAFF_GU]
		,[STAFF_SCHOOL_YEAR].[ORGANIZATION_YEAR_GU]
		,0 AS [PRIMARY_STAFF]
	FROM
		rev.[EPC_SCH_YR_SECT_STF] AS [SECONDARY_STAFF]
		
		INNER JOIN
		rev.[EPC_STAFF_SCH_YR] AS [STAFF_SCHOOL_YEAR]
		ON
		[SECONDARY_STAFF].[STAFF_SCHOOL_YEAR_GU] = [STAFF_SCHOOL_YEAR].[STAFF_SCHOOL_YEAR_GU]
	) AS [ALL_STAFF_SCH_YR]
	ON
   [SCHEDULE].[STAFF_SCHOOL_YEAR_GU] = [ALL_STAFF_SCH_YR].[STAFF_SCHOOL_YEAR_GU]
   
	INNER JOIN
	rev.[EPC_STAFF] AS [STAFF]
	ON
	[ALL_STAFF_SCH_YR].[STAFF_GU] = [STAFF].[STAFF_GU]

	INNER JOIN
	rev.[REV_PERSON] AS [STAFF_PERSON]
	ON
	[STAFF].[STAFF_GU] = [STAFF_PERSON].[PERSON_GU]

LEFT JOIN 
rev.EPC_STAFF_CRD AS CRD
ON
CRD.STAFF_GU = STAFF.STAFF_GU
AND AUTHORIZED_TCH_AREA IN ('67', '27')
	
	INNER JOIN 
	rev.REV_YEAR AS YRS
	ON
	YRS.YEAR_GU = SCHEDULE.YEAR_GU

WHERE 
ORGANIZATION_NAME LIKE 'Alamosa%'
AND SCHOOL_YEAR = '2014'

) AS CLASSES

ON
CLASSES.STUDENT_GU = ENR.STUDENT_GU


--PULL TESTS
LEFT JOIN 

(SELECT * FROM (

SELECT 
       SCHOOL
	   ,SYN.FIRST_NAME
       ,SYN.LAST_NAME
      -- ,ACCU.STUDENT_CODE
       ,SIS_NUMBER
	   ,STUDENT_GU
       ,GRADE
	   ,TEST_NAME
      -- ,ACCU.TEST_SECTION_NAME
       ,PART_DESCRIPTION
       ,SCORE_DESCRIPTION
       ,PERFORMANCE_LEVEL
       ,TEST_SCORE
       --,ACCU.SCALED_SCORE
       ,CAST (ADMIN_DATE AS DATE) AS DATES
       ,ADMIN_DATE
       ,PART_NUMBER
	   ,ROW_NUMBER() OVER (PARTITION BY SIS_NUMBER ORDER BY ADMIN_DATE DESC) AS RN
FROM
(
SELECT 
       ORG.ORGANIZATION_NAME AS SCHOOL
	   ,Student.STUDENT_GU
	   ,PERSON.FIRST_NAME
       ,PERSON.LAST_NAME
       ,SIS_NUMBER
       ,Enroll.GRADE
	   ,TEST.TEST_NAME
   	   ,PART_DESCRIPTION
       ,SCORE_DESCRIPTION
       ,STU_PART.PERFORMANCE_LEVEL
       ,SCORES.TEST_SCORE
       ,STUDENTTEST.ADMIN_DATE
       ,PART.PART_NUMBER
FROM
       rev.EPC_STU_TEST AS StudentTest

       JOIN
       rev.EPC_TEST_PART AS PART
       ON StudentTest.TEST_GU = PART.TEST_GU

       JOIN
       rev.EPC_STU_TEST_PART AS STU_PART
       ON PART.TEST_PART_GU = STU_PART.TEST_PART_GU
       AND STU_PART.STUDENT_TEST_GU = StudentTest.STUDENT_TEST_GU

    INNER JOIN
    rev.EPC_STU_TEST_PART_SCORE AS SCORES
    ON
    SCORES.STU_TEST_PART_GU = STU_PART.STU_TEST_PART_GU

    LEFT JOIN
    rev.EPC_TEST_SCORE_TYPE AS SCORET
    ON
    SCORET.TEST_GU = StudentTest.TEST_GU
    AND SCORES.TEST_SCORE_TYPE_GU = SCORET.TEST_SCORE_TYPE_GU

    LEFT JOIN
    rev.EPC_TEST_DEF_SCORE AS SCORETDEF
    ON
    SCORETDEF.TEST_DEF_SCORE_GU = SCORET.TEST_DEF_SCORE_GU

       LEFT JOIN
       rev.EPC_TEST AS TEST
       ON TEST.TEST_GU = StudentTest.TEST_GU

       INNER JOIN
       rev.EPC_STU AS Student
       ON Student.STUDENT_GU = StudentTest.STUDENT_GU

       INNER JOIN
       rev.REV_PERSON AS Person
       ON Person.PERSON_GU = StudentTest.STUDENT_GU

       INNER JOIN
       (SELECT DISTINCT STUDENT_GU, ORGANIZATION_YEAR_GU, GRADE FROM 
		APS.StudentEnrollmentDetails
		WHERE
		SCHOOL_YEAR = '2014'
		AND EXTENSION = 'R'
		AND SCHOOL_CODE = '210'
		AND SUMMER_WITHDRAWL_CODE IS NULL
	   
	  )  AS Enroll
	   
	   
	   ON
       StudentTest.STUDENT_GU = Enroll.STUDENT_GU

       INNER JOIN
       rev.REV_ORGANIZATION_YEAR AS OrgYear
       ON
       Enroll.ORGANIZATION_YEAR_GU = OrgYear.ORGANIZATION_YEAR_GU

       INNER JOIN
       rev.REV_ORGANIZATION AS Org
       ON
       OrgYear.ORGANIZATION_GU = Org.ORGANIZATION_GU


WHERE
       TEST_NAME like '%ACCESS%'
	
) AS SYN

) AS T1
--WHERE
--RN = 1
) AS ACCESS_TESTS

ON
ACCESS_TESTS.STUDENT_GU = ENR.STUDENT_GU


WHERE
SCHOOL_YEAR = '2014'
AND EXTENSION = 'R'
AND SCHOOL_CODE = '210'
--AND ACCESS_TESTS.ADMIN_DATE != '2015-06-01'
AND ACCESS_TESTS.ADMIN_DATE > '2012-06-01'

--and stu.SIS_NUMBER = 104605530


ORDER BY SIS_NUMBER