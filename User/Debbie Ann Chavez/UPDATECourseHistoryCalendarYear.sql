
--BEGIN TRAN

--UPDATE REV.EPC_STU_CRS_HIS

--SET CALENDAR_YEAR = '2017'
--,CHANGE_DATE_TIME_STAMP = GETDATE()
--,CHANGE_ID_STAMP = '27CDCD0E-BF93-4071-94B2-5DB792BB735F'

--FROM
--(
SELECT 
CASE WHEN NON.SCHOOL_NON_DISTRICT_GU IS NOT NULL THEN NON.NAME ELSE ORGANIZATION_NAME END AS SCHOOL_NAME
,ENROLL.SCHOOL_NAME AS MOST_RECENT_PRIMARY_SCHOOL_2017
,STU.SIS_NUMBER
,HIST.CALENDAR_YEAR
,HIST.SCHOOL_YEAR
,HIST.CALENDAR_MONTH
,HIST.COURSE_ID
,HIST.COURSE_TITLE
,HIST.SECTION_ID
,HIST.MARK
,HIST.CREDIT_COMPLETED
,hist.STU_COURSE_HISTORY_GU


 FROM 
REV.EPC_STU_CRS_HIS AS HIST
LEFT HASH JOIN 
REV.REV_ORGANIZATION AS ORG
ON
HIST.SCHOOL_IN_DISTRICT_GU = ORG.ORGANIZATION_GU
LEFT HASH JOIN 
REV.EPC_SCH AS SCH
ON
SCH.ORGANIZATION_GU = ORG.ORGANIZATION_GU

LEFT HASH JOIN 
REV.EPC_SCH_NON_DST AS NON
ON
NON.SCHOOL_NON_DISTRICT_GU = HIST.SCHOOL_NON_DISTRICT_GU
INNER HASH JOIN 
REV.EPC_STU AS STU
ON
HIST.STUDENT_GU = STU.STUDENT_GU

LEFT HASH JOIN 
APS.LatestPrimaryEnrollmentInYear ('A3F9F1FB-4706-49AA-B3A3-21F153966191') AS ENROLL
ON
ENROLL.STUDENT_GU = STU.STUDENT_GU


WHERE
HIST.SCHOOL_YEAR = '2017' AND CALENDAR_YEAR = '2016' AND CALENDAR_MONTH = '12'
--AND SCH.SCHOOL_CODE IN ('576', '540', '570', '520', '560', '496', '550')
--AND 
--SIS_NUMBER = 103443917

--) AS T1

--WHERE
--T1.STU_COURSE_HISTORY_GU = REV.EPC_STU_CRS_HIS.STU_COURSE_HISTORY_GU

--ROLLBACK

ORDER BY ENROLL.STUDENT_GU