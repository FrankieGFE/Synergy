
EXECUTE AS LOGIN='QueryFileUser'
GO


SELECT 
	*
	
	FROM
            OPENROWSET (
                  'Microsoft.ACE.OLEDB.12.0', 
                 'Text;Database=\\SYNTEMPSSIS\Files\TempQuery;',
                  'SELECT * from JUDEFILE.csv'
                ) AS [T1]


INNER JOIN 
(SELECT 
DISTINCT
	ENR.SIS_NUMBER
	--,ORGANIZATION_NAME
	,LAST_NAME
	,FIRST_NAME
	,ENR.GRADE
	,STU.EXPECTED_GRADUATION_YEAR
	,STU.GRADUATION_DATE
	,STU.DIPLOMA_TYPE
	,DP.VALUE_DESCRIPTION AS DIP_DESC
	,STU.POST_SECONDARY
	,PS.VALUE_DESCRIPTION AS PS_DESC
	,STU.GRADUATION_STATUS
	,GS.VALUE_DESCRIPTION AS GS_DESC
	,TOTAL

 FROM 
APS.StudentEnrollmentDetails AS ENR
INNER JOIN 
		(
		SELECT * FROM (
		SELECT 
				SUM(CREDIT_COMPLETED) AS TOTAL
				,STU.STUDENT_GU 
			 FROM 

			rev.EPC_STU_CRS_HIS AS HIS
			INNER JOIN 
			REV.EPC_STU AS STU
			ON
			HIS.STUDENT_GU = STU.STUDENT_GU
			LEFT JOIN
			[rev].[EPC_REPEAT_TAG] AS [Repeat]
			ON
			HIS.[REPEAT_TAG_GU]=[Repeat].[REPEAT_TAG_GU]

			WHERE
			HIS.COURSE_HISTORY_TYPE = 'HIGH'
			 AND ISNULL([Repeat].[REPEAT_CODE],'')!='R'
			 GROUP BY STU.STUDENT_GU
			 ) AS T1
			 WHERE
				TOTAL >='25.00'

) AS CREDITS
ON
ENR.STUDENT_GU = CREDITS.STUDENT_GU

INNER JOIN 
rev.REV_ORGANIZATION_YEAR AS ORGYR
ON
ORGYR.ORGANIZATION_YEAR_GU = ENR.ORGANIZATION_YEAR_GU
INNER JOIN 
rev.REV_ORGANIZATION AS ORG
ON
ORG.ORGANIZATION_GU = ORGYR.ORGANIZATION_GU
INNER JOIN 
rev.REV_PERSON AS PERS
ON
ENR.STUDENT_GU = PERS.PERSON_GU
INNER JOIN 
rev.EPC_STU AS STU
ON 
ENR.STUDENT_GU = STU.STUDENT_GU
LEFT JOIN 
APS.LookupTable('K12', 'GRADUATION_STATUS') AS GS
ON
GS.VALUE_CODE = STU.GRADUATION_STATUS
LEFT JOIN 
APS.LookupTable('K12', 'DIPLOMA_TYPE') AS DP
ON
DP.VALUE_CODE = STU.DIPLOMA_TYPE
LEFT JOIN 
APS.LookupTable('K12.DEMOGRAPHICS', 'POST_SECONDARY')  AS PS
ON
PS.VALUE_CODE = STU.POST_SECONDARY


WHERE
ENR.SCHOOL_YEAR = '2015'
) AS T2
ON
T1.ID = T2.SIS_NUMBER

	
REVERT
GO