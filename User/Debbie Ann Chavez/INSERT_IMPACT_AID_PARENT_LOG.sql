
EXECUTE AS LOGIN='QueryFileUser'
GO

BEGIN TRANSACTION

INSERT INTO REV.UD_PARENT_LOG

SELECT
	NEWID() AS UDPARENT_LOG_GU 
	,GETDATE() AS ADD_DATE_TIME_STAMP
	,'27CDCD0E-BF93-4071-94B2-5DB792BB735F' AS ADD_ID_STAMP
	,NULL AS CHANGE_DATE_TIME_STAMP
	,NULL AS CHANGE_ID_STAMP
	,NULL AS DATE_RESENT_ERROR
	,NULL AS DATE_RETURNED_ERROR
	,WRITINGALLTHESE.RETURNED AS DATE_SURVEY_RETURNED
	,WRITINGALLTHESE.CAT AS HOW_FIRST_PARENT_QUALIFIED
	,NULL AS HOW_SECOND_PARENT_QUALIFIED
	,WRITINGALLTHESE.PARENT_GU AS PARENT_GU
	,WRITINGALLTHESE.QUALIFIED AS QUALIFIED
	,NULL AS REFUSED_TO_SIGN
	,NULL AS SECOND_PARENT_QUALIFIED
	,WRITINGALLTHESE.[TABLE] AS [TABLE]
	,WRITINGALLTHESE.[Date] AS [DATE]
	,NEW_GRANT AS [GRANT]

FROM

(
SELECT DISTINCT

T2.PARENT_GU
,CASE WHEN ORIGINALFILE.RETURNED = 'NULL' THEN NULL ELSE RETURNED END AS RETURNED
,CASE WHEN ORIGINALFILE.CAT = 'NULL' THEN NULL ELSE CAT END AS CAT
,CASE WHEN ORIGINALFILE.QUALIFIED = 'NULL' THEN NULL ELSE QUALIFIED END AS QUALIFIED
,CASE WHEN ORIGINALFILE.[TABLE] = 'NULL' THEN NULL ELSE [TABLE] END AS [TABLE]
,CASE WHEN ORIGINALFILE.[Date] = 'NULL' THEN '2016-09-12' ELSE [Date] END AS [Date]
,CASE WHEN ORIGINALFILE.NEW_GRANT = 'NULL' THEN NULL ELSE NEW_GRANT END AS NEW_GRANT
,CASE WHEN T2.PARENT_GU IS NOT NULL THEN 'X' ELSE '' END AS WRITING_THESE


FROM 

(
SELECT 
	*
FROM 

            OPENROWSET (
                  'Microsoft.ACE.OLEDB.12.0', 
                 'Text;Database=\\SYNTEMPSSIS\Files\TempQuery;',
                  'SELECT * from WRITEALLIMPACTAIDE.csv'
                ) AS [T1]
) AS ORIGINALFILE	

-- CHANGE TO LEFT JOIN TO PULL IN RECORDS THAT WERE NOT FOUND -- WRITE TO FILE FOR JUDE/PATTI TO RESEARCH
INNER JOIN 

(
-- THESE ARE THE RECORDS I'M GOING TO WRITE OUT -- 
	SELECT DISTINCT
	T1.[SIS NUMBER], T1.[PARENT NAME],
	PERS.LAST_NAME, PERS.FIRST_NAME, PARENTS.PARENT_GU

	FROM
            OPENROWSET (
                  'Microsoft.ACE.OLEDB.12.0', 
                 'Text;Database=\\SYNTEMPSSIS\Files\TempQuery;',
                  'SELECT * from WRITEALLIMPACTAIDE.csv'
                ) AS [T1]
	
INNER JOIN 
REV.EPC_STU AS STU
ON
[T1].[SIS NUMBER] = STU.SIS_NUMBER

INNER JOIN 
REV.EPC_STU_PARENT AS PARENTS
ON
STU.STUDENT_GU = PARENTS.STUDENT_GU

INNER JOIN 
REV.REV_PERSON AS PERS
ON
PARENTS.PARENT_GU = PERS.PERSON_GU
AND LEFT(T1.[PARENT NAME],3) = LEFT(PERS.FIRST_NAME,3) 


) AS T2

ON
ORIGINALFILE.[SIS NUMBER] = T2.[SIS NUMBER]
AND ORIGINALFILE.[PARENT NAME] = T2.[PARENT NAME]


--ORDER BY WRITING_THESE
) AS WRITINGALLTHESE

LEFT JOIN 
REV.UD_PARENT_LOG AS LOGS
ON
LOGS.PARENT_GU = WRITINGALLTHESE.PARENT_GU
AND COALESCE(LOGS.[DATE],GETDATE()) != COALESCE(WRITINGALLTHESE.[Date], GETDATE())
AND COALESCE(LOGS.[GRANT],'XXX') != COALESCE(WRITINGALLTHESE.[NEW_GRANT], 'XXX')
AND COALESCE(LOGS.[QUALIFIED],'XX') != COALESCE(WRITINGALLTHESE.[QUALIFIED], 'XX')
AND COALESCE(LOGS.[TABLE],0) != COALESCE(WRITINGALLTHESE.[TABLE],0)
AND COALESCE(LOGS.HOW_FIRST_PARENT_QUALIFIED,'1234') != COALESCE(WRITINGALLTHESE.CAT,'1234')


ROLLBACK

REVERT
GO