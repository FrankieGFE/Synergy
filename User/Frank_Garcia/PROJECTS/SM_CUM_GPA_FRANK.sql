

SELECT
	*
FROM
(
SELECT 
	ID_NBR
	,[FLAT GPA]
	,SCH_YR
FROM
(
SELECT
	DST_NBR
	,SCH_YR
	,ID_NBR

	,CASE 
		WHEN SUM(CASE WHEN EXCL_FR_TN != 'X' THEN ATT_CRD ELSE 0 END) != 0 
		THEN
			SUM(CASE WHEN EXCL_FR_TN != 'X' THEN GRAD_VALUE * EARNED_CRS ELSE 0 END)
			/SUM(
			CASE 
				WHEN EXCL_FR_TN != 'X' THEN 
					CASE 
						WHEN EARNED_CRS > ATT_CRD THEN EARNED_CRS 
						ELSE ATT_CRD 
					END 
				ELSE 0 
			END			
			)
		ELSE
			0
	END AS [FLAT GPA]
			 
	,SUM(CASE WHEN HNRS_FLG = 'X' AND EXCL_FR_TN != 'X' THEN EARNED_CRS * WGHT_FACT1 ELSE 0 END) AS [Honors Points]
	
	,CASE 
		WHEN SUM(CASE WHEN EXCL_FR_TN != 'X' THEN ATT_CRD ELSE 0 END) != 0 
		THEN
			(SUM(CASE WHEN EXCL_FR_TN != 'X' THEN GRAD_VALUE * EARNED_CRS ELSE 0 END)
			/SUM(
			CASE 
				WHEN EXCL_FR_TN != 'X' THEN 
					CASE 
						WHEN EARNED_CRS > ATT_CRD THEN EARNED_CRS 
						ELSE ATT_CRD 
					END 
				ELSE 0 
			END
			))
			+
			SUM(CASE WHEN HNRS_FLG = 'X' AND EXCL_FR_TN != 'X' THEN EARNED_CRS * WGHT_FACT1 ELSE 0 END)
		ELSE
			0
	END AS [Weighted GPA]
	,SUM(
		CASE 
			WHEN EXCL_FR_TN != 'X' THEN 
				CASE 
					WHEN EARNED_CRS > ATT_CRD THEN EARNED_CRS 
					ELSE ATT_CRD 
				END 
			ELSE 0 
		END
	) AS [Attempted Credits]
	,SUM(CASE WHEN EXCL_FR_TN != 'X' THEN EARNED_CRS ELSE 0 END) AS [Earned Credits]
			
FROM
	[180-SMAXODS-01].PR.APS.FinalGradesAndTranscript
WHERE
	GPA_USE = 'X'
	--and  ID_NBR = '102785458'
GROUP BY
	DST_NBR
	,SCH_YR
	,ID_NBR
) AS TT
)GPA_CUM
--PIVOT
	--(MAX([FLAT GPA]) FOR SCH_YR IN ([2010],[2011],[2012],[2013],[2014])) AS UP1

GO


