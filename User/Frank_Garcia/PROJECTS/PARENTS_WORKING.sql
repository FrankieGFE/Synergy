BEGIN TRAN


SELECT
	STUDENT.ID_NBR AS SIS_NUMBER
	,FAMILY.FAM_NBR AS FAM_NBR
	,PARENT.HH_NBR
	,CASE
		WHEN PARENT.HH_NBR = 1 THEN FAMILY.RLTN_HH1
		WHEN PARENT.HH_NBR = 2 THEN FAMILY.RLTN_HH2 
		END
		AS RELATION_TYPE -- LOOK UP TABLE BLANK = CAREGIVER
	,FAMILY.RLTN_HH2
	,FAMILY.HH_LGL
	,APS.FormatTitleCase (PARENT.LST_NME) AS LAST_NAME
	,APS.FormatTitleCase (PARENT.FRST_NME) AS FIRST_NAME
	,PARENT.M_NME AS MIDDLE_NAME
	,'' AS SUFFIX
	,FAMILY.PRIM_FAM AS PRIMARY_FAMILY
	
	--------DWELLING ADDRESS-----------------------------------------------------------------------------------
	,REPLACE(REPLACE(REPLACE(
	ISNULL(CASE WHEN DWELL IS NOT NULL THEN '' ELSE APS.FormatTitleCase(Address) END, '') 
	, CHAR(10), ''), CHAR(13), ''), CHAR(9), '')
	AS HOME_ADDRESS
	,ISNULL(CASE WHEN DWELL IS NOT NULL THEN '' ELSE APS.FormatTitleCase(City) END, '') AS HOME_CITY
	,ISNULL(CASE WHEN DWELL IS NOT NULL THEN '' ELSE State END, '')	AS HOME_STATE
	,CASE WHEN DWELL IS NOT NULL THEN '' ELSE Zip END AS HOME_ZIP
	-- 3 min 43 seconds withouth this:
	
	----------COMPARE DWELLING ADDRESS AND MAILING ADDRESS-----------------------------------------------------
	,REPLACE(REPLACE(REPLACE(
	CASE WHEN 
		ISNULL(CASE WHEN DWELL IS NOT NULL THEN '' ELSE APS.FormatTitleCase(Address) END, '')
	!= ISNULL(CASE WHEN FAMNBR IS NOT NULL THEN '' ELSE APS.FormatTitleCase(FAM.ADDR_LNE_1) END, '') 
	THEN APS.FormatTitleCase(FAM.ADDR_LNE_1) ELSE '' END 
	, CHAR(10), ''), CHAR(13), ''), CHAR(9), '')
	AS MAIL_ADDRESS	
	
	,CASE WHEN 
		ISNULL(CASE WHEN DWELL IS NOT NULL THEN '' ELSE APS.FormatTitleCase(Address) END, '')
	!= ISNULL(CASE WHEN FAMNBR IS NOT NULL THEN '' ELSE APS.FormatTitleCase(FAM.CITY) END, '') 
	THEN APS.FormatTitleCase(FAM.CITY) ELSE ''  END AS MAIL_CITY
	
	,CASE WHEN 
		ISNULL(CASE WHEN DWELL IS NOT NULL THEN '' ELSE APS.FormatTitleCase(Address) END, '')
	!= ISNULL(CASE WHEN FAMNBR IS NOT NULL THEN '' ELSE FAM.STATE END, '') 
	THEN FAM.STATE ELSE ''  END AS MAIL_STATE

	,CASE WHEN 
		ISNULL(CASE WHEN DWELL IS NOT NULL THEN '' ELSE APS.FormatTitleCase(Address) END, '')
	!= ISNULL(CASE WHEN FAMNBR IS NOT NULL THEN '' ELSE APS.FormatZip(FAM.ZIP_CD) END, '') 
	THEN APS.FormatZip(FAM.ZIP_CD) ELSE '' END AS MAIL_ZIPCODE

	---------------------------------------------------------------------------------------------------------------
	
	
	
	,CASE
		WHEN MAIL.HM_AREA_CD = 00 THEN '' ELSE CAST (MAIL.HM_AREA_CD AS VARCHAR(3)) + CAST (MAIL.HM_PHNE AS VARCHAR (7)) END AS PHONE
	,CASE WHEN MAIL.HM_PHNE = 00 THEN ' ' ELSE 'H' END AS PHONE_TYPE
	,'' AS PHONE_EXTN
	,CASE WHEN MAIL.UNLISTED != '' THEN '' 
	      WHEN MAIL.HM_PHNE = 00 THEN ''
	      ELSE 'Y' END AS PHONE_LISTED -- WHEN HM_PHNE = 00 THEN ''  ADD THIS
	,CASE WHEN MAIL.HM_PHNE = 0 THEN '' ELSE 'Y' END AS PHONE_CONTACT
	,CASE WHEN MAIL.HM_PHNE = 0 THEN '' ELSE 'Y' END AS PHONE_PRIMARY
	,CASE WHEN PARENT.F1_PHNE = 00 THEN '' ELSE (CAST (PARENT.F1_AREA_CD AS VARCHAR (3))+ CAST (PARENT.F1_PHNE AS VARCHAR (7))) END AS PHONE2
	,PARENT.F1_TYPE AS PHONE2_TYPE
	,PARENT.F1_PH_EXT AS PHONE2_EXTN
	,'' AS PHONE2_LISTED
	,CASE WHEN PARENT.F1_DAY != '' THEN 'Y' ELSE '' END AS PHONE2_CONTACT
	,'' AS PHONE2_PRIMARY
	,CASE WHEN PARENT.F2_PHNE = 00 THEN '' ELSE (CAST (PARENT.F2_AREA_CD AS VARCHAR (3))+ CAST (PARENT.F2_PHNE AS VARCHAR (7))) END AS PHONE3
	,PARENT.F2_TYPE AS PHONE3_TYPE
	,'' AS PHONE3_EXTN
	,'' AS PHONE3_LISTED
	,CASE WHEN PARENT.F2_DAY != '' THEN 'Y' ELSE '' END AS PHONE3_CONTACT
	,'' AS PHONE3_PRIMARY
	,CASE WHEN PARENT.F3_PHNE = 00 THEN '' ELSE (CAST (PARENT.F3_AREA_CD AS VARCHAR (3))+ CAST (PARENT.F3_PHNE AS VARCHAR (7))) END AS PHONE4
	,PARENT.F3_TYPE AS PHONE4_TYPE
	,'' AS PHONE4_EXTN
	,'' AS PHONE4_LISTED
	,CASE WHEN PARENT.F3_DAY != '' THEN 'Y' ELSE '' END AS PHONE4_CONTACT
	,'' AS PHONE4_PRIMARY
	,PARENT.HH_GENDER AS GENDER
	,'' AS ETHNIC_CODE
	,'' AS RACE1
	,'' AS RACE2
	,'' AS RACE3
	,'' AS RACE4
	,'' AS RACE5
	,'' AS HISPANIC_INDICATOR
	,CASE WHEN PARENT.HH_BRTH != 0
		THEN
		CONVERT (VARCHAR(12),PARENT.HH_BRTH, 112)  
		END AS BIRTHDATE
	,'' AS BIRTHPLACE
	,'' AS SOCIAL_SECURITY_NUMBER	
	,RIGHT('00'+ CAST(PARENT.HH_LANG_CD AS VARCHAR),3)	AS PRIMARY_LANGUAGE	
	,'' AS US_CITIZEN
	,PARENT.EMAIL AS E_MAIL
	,PARENT.PRE_NME AS TITLE
	,EMPLOYEE.EMP_ABBR AS EMPLOYER
	,CASE WHEN PARENT.HH_OC_CD = 'Y' THEN 'ACTIVE MILITARY' ELSE '' END AS JOB_TITLE
	--,PARENT.HH_OC_CD AS ACTIVE_MILITARY
	,'' AS ADDITIONALINFO
	,'' AS COMMENT
	-- HH_LGL WITH STUDENT IF 0 NEITHER PRIMARY PARENT LGL 1 = HH1 LGL 2 = HH2 LGL 3 = BOTH LGL
	-- USE FAM_NBR 188178 TO SEE EXAMPLE IN CE810 ANC CE015
	,CASE WHEN PARENT.HH_NBR = 1 AND FAMILY.RSTRCT_HH1 = '' THEN 'Y'
		  WHEN PARENT.HH_NBR = 2 AND FAMILY.RSTRCT_HH2 = '' THEN 'Y'
		  ELSE ''
		  END AS CONTACT_ALLOWED
	,CASE WHEN FAMILY.HH_LGL != 0 THEN 'Y' ELSE 'N' END AS EDUCATIONAL_RIGHTS
	,CASE WHEN FAMILY.HH_LGL = 0 AND (HH_NBR = 1 OR HH_NBR = 2) THEN ''
		  WHEN FAMILY.HH_LGL = 1  AND (HH_NBR = 1) THEN 'Y'
		  WHEN FAMILY.HH_LGL = 2  AND (HH_NBR = 2) THEN 'Y'
		  WHEN FAMILY.HH_LGL = 3 AND (HH_NBR = 1 OR HH_NBR = 2) THEN 'Y'
		  END AS HAS_CUSTODY
	,CASE WHEN FAMILY.LIVE_WITH = 'X' THEN 'Y' ELSE '' END AS LIVES_WITH
	,CASE WHEN FAMILY.LIVE_WITH = 'X' THEN 'Y' ELSE '' END AS MAILINGS_ALLOWED
	,PARENT.HH_ED_CD AS EDUCATION_LEVEL 
	,'' AS WORK_ADDRESS
	,'' AS WORK_CITY
	,'' AS WORK_STATE
	,'' AS WORK_ZIPCODE
	,'' AS FEEDER_DISTRICT_ID
	,'' AS FEEDER_STUDENT_ID
	,CASE WHEN FAMILY.HH_LGL = 0 AND (HH_NBR = 1 OR HH_NBR = 2) THEN ''
		  WHEN FAMILY.HH_LGL = 1  AND (HH_NBR = 1) THEN 'Y'
		  WHEN FAMILY.HH_LGL = 2  AND (HH_NBR = 2) THEN 'Y'
		  WHEN FAMILY.HH_LGL = 3 AND (HH_NBR = 1 OR HH_NBR = 2) THEN 'Y'
		  END AS  RELEASE_TO
	,'' AS ENROLLING_PARENT
	
	
	
	
	
	
	



	
	

FROM
	DBTSIS.CE020_V AS STUDENT	
	LEFT JOIN
	DBTSIS.CE810_V	AS FAMILY
	ON
	STUDENT.ID_NBR = FAMILY.ID_NBR	
	AND STUDENT.DST_NBR = FAMILY.DST_NBR
	
	LEFT JOIN
	DBTSIS.CE015_V AS PARENT
	ON
	FAMILY.FAM_NBR = PARENT.FAM_NBR
	AND STUDENT.DST_NBR = PARENT.DST_NBR
	
	LEFT JOIN 
	DBTSIS.CE055_V AS EMPLOYEE
	ON
	PARENT.HH_EMP_CD = EMPLOYEE.EMP_CD
	AND STUDENT.DST_NBR = EMPLOYEE.DST_NBR
		
	LEFT JOIN
	DBTSIS.CE010_V AS MAIL
	ON
	PARENT.FAM_NBR = MAIL.FAM_NBR
	AND STUDENT.DST_NBR = MAIL.DST_NBR
	
	LEFT JOIN
	DBTSIS.CE005_V AS DWELLING
	ON
	MAIL.DWL_NBR = DWELLING.DWL_NBR
	AND STUDENT.DST_NBR = DWELLING.DST_NBR
	
	-------------READ FILE OF BAD DWELLINGS TO BLANK OUT--------------------------------
LEFT HASH JOIN
OPENROWSET ('MSDASQL', 'Driver={Microsoft Access Text Driver (*.txt, *.csv)};DBQ=D:\SQLWorkingFiles;', 'SELECT * from "BadDwelling.csv"')
		AS BADDWELL
ON
DWELLING.DWL_NBR = BADDWELL.[DWELL]

-------------READ FILE OF BAD MAILING ADDRESSES TO BLANK OUT------------------------
LEFT HASH JOIN
OPENROWSET ('MSDASQL', 'Driver={Microsoft Access Text Driver (*.txt, *.csv)};DBQ=D:\SQLWorkingFiles;', 'SELECT * from "BadMailing.csv"')
		AS BADMAIL
ON
PARENT.FAM_NBR = BADMAIL.[FAMNBR]
	

WHERE 
	STUDENT.DST_NBR = 1	
	--AND FAMILY.RLTN_HH1 != ''
	--AND PARENT.HH_NBR = 1 -- HH_NBR RELATED TO RLTN_HH1 OR RLTN_HH2
	AND STUDENT.ID_NBR = 422443531
	--AND PARENT.FAM_NBR = 329234
ORDER BY
	--JOB_TITLE DESC,
	FAM_NBR
	--RELATION_TYPE,
	--STUDENT.ID_NBR	
	

ROLLBACK