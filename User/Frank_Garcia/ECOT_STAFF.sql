USE [ST_Production]
GO

/****** Object:  View [APS].[EKOTStaff]    Script Date: 6/8/2017 9:49:14 AM ******/
--SET ANSI_NULLS ON
--GO

--SET QUOTED_IDENTIFIER ON
--GO


--ALTER VIEW [APS].[EKOTStaff] AS

SELECT DISTINCT
	'BOY' AS [WindowName]
	,'001' AS [DistrictCode]
	,[School].[SCHOOL_CODE] AS [LocationCode]
	,[STAFF_PERSON].[FIRST_NAME] AS [FirstName]
	,[STAFF_PERSON].[LAST_NAME] AS [LastName]
	,RIGHT(CONVERT(VARCHAR(9),REPLACE([LAWSON].[FICA_NBR],'-','')),5) AS [StaffID]
	,[STAFF_PERSON].[EMAIL] AS [Email]
	,CONVERT(VARCHAR(10),[STAFF_PERSON].[BIRTH_DATE],101) AS [Birthdate]
	,[STAFF_PERSON].[GENDER]
	,'' AS [Statement]
	,'' AS [ErrorDesc]
	--,GRADE
	--,COURSE_ENTER_DATE
	--,COURSE_LEAVE_DATE
	--,ENROLLMENT_LEAVE_DATE
	--,ENROLLMENTS.GRADE
	--,SCHEDULE.STUDENT_GU

FROM
	APS.BasicSchedule AS [SCHEDULE]
	
	INNER JOIN
	APS.StudentEnrollmentDetails AS [ENROLLMENTS]
	ON
	[SCHEDULE].[STUDENT_SCHOOL_YEAR_GU] = [ENROLLMENTS].[STUDENT_SCHOOL_YEAR_GU]
	AND ENROLLMENTS.LEAVE_DATE IS NULL
	AND SCHEDULE.COURSE_LEAVE_DATE IS NULL
	
	INNER JOIN 
	rev.REV_ORGANIZATION AS [Organization] -- Contains the School Name
	ON 
	[SCHEDULE].[ORGANIZATION_GU] = [Organization].[ORGANIZATION_GU]
	
	INNER JOIN 
	rev.EPC_SCH AS [School] -- Contains the School Code / Number
	ON 
	[Organization].[ORGANIZATION_GU] = [School].[ORGANIZATION_GU]
	
	INNER JOIN
	rev.[REV_YEAR] AS [YEAR]
	ON
	[SCHEDULE].[YEAR_GU] = [YEAR].[YEAR_GU]	
   
	INNER JOIN
	rev.[EPC_STAFF] AS [STAFF]
	ON
	[SCHEDULE].[STAFF_GU] = [STAFF].[STAFF_GU]

	INNER JOIN
	rev.[REV_PERSON] AS [STAFF_PERSON]
	ON
	[STAFF].[STAFF_GU] = [STAFF_PERSON].[PERSON_GU]

	INNER JOIN
	rev.EPC_CRS CRS
	ON 
	SCHEDULE.COURSE_GU = CRS.COURSE_GU
	
	LEFT OUTER JOIN
	(
	SELECT 
		   -- IN SYNERGY USE THE BADGE_NUMBER SUBSTRING(BADGE_NUMBER,2,6) OR USE THE STATE_NUMBER (has no 'e') and join to the EMPLOYEE field in the EMPLOYEE table.
		   EMPLOYEE
		   ,FICA_NBR
	FROM 
	[180-SMAXODS-01.aps.edu.actd].Lawson.dbo.Employee
	) AS [LAWSON]
	ON
	REPLACE([STAFF].[BADGE_NUM],'e','') = [LAWSON].[EMPLOYEE]
	
WHERE	
	([YEAR].[SCHOOL_YEAR] = '2017' AND [YEAR].[EXTENSION] = 'N')
	--AND [School].[SCHOOL_CODE] IN ('315','321','207','329','229','203','241','244','350','219','255','328','267','270','395','276','217','300','317','360','389','363','370','264')
	--AND [School].[SCHOOL_CODE] BETWEEN '200' AND '399'
	
	AND [STAFF_PERSON].[LAST_NAME] != 'Closed'
	AND [STAFF_PERSON].[BIRTH_DATE] IS NOT NULL
	--AND (ENROLLMENT_LEAVE_DATE IS NULL OR SCHEDULE.COURSE_LEAVE_DATE IS NULL)
	AND [ENROLLMENTS].[GRADE] IN ('P1','P2','PK','K')
	--AND CRS.COURSE_ID NOT LIKE 'L%'
	--AND CRS.COURSE_ID NOT LIKE 'P%'
	--AND CRS.COURSE_ID NOT LIKE 'M%'
	--AND [STAFF].[BADGE_NUM] != 'e141026'

	--and staff.BADGE_NUM in ('e141652','e133506')
	--ORDER BY LAST_NAME, FIRST_NAME

--GO


