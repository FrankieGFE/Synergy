;WITH SCIENCE_2014 
AS
(
SELECT DISTINCT ----TEST_NAME
    SIS_SCHOOL_YEAR AS 'School Year'
       ,STUD.STUDENT_ID AS 'Student APS ID'
       ,SDET.STUDENT_STATE_ID AS 'Student STATE_ID'
    ,TEST_PRIMARY_RESULT AS 'Science Overall Performance Level'
    ,CAST(TEST_SCALED_SCORE AS INT) AS 'Science Scale Score'
       ,TEST_NAME
       ,TEST_PRODUCT
       ,TEST_GROUP
       ,TEST_SUBGROUP
FROM K12INTEL_DW.FTBL_TEST_SCORES
INNER JOIN K12INTEL_DW.DTBL_TESTS
ON DTBL_TESTS.TESTS_KEY = FTBL_TEST_SCORES.TESTS_KEY 
INNER JOIN K12INTEL_DW.DTBL_STUDENTS STUD
ON STUD.STUDENT_KEY = FTBL_TEST_SCORES.STUDENT_KEY 
INNER JOIN K12INTEL_DW.DTBL_SCHOOLS
ON DTBL_SCHOOLS.SCHOOL_KEY = FTBL_TEST_SCORES.SCHOOL_KEY
INNER JOIN K12INTEL_DW.DTBL_CALENDAR_DATES
ON DTBL_CALENDAR_DATES.CALENDAR_DATE_KEY= FTBL_TEST_SCORES.CALENDAR_DATE_KEY
INNER JOIN K12INTEL_DW.DTBL_SCHOOL_DATES
ON DTBL_SCHOOL_DATES.SCHOOL_DATES_KEY = FTBL_TEST_SCORES.SCHOOL_DATES_KEY 
JOIN
[K12INTEL_DW].[DTBL_STUDENT_DETAILS] AS SDET
ON SDET.STUDENT_ID = STUD.STUDENT_ID
WHERE 
1 = 1
AND TEST_PRODUCT = 'SBA-NM'
AND TEST_GROUP = 'SCIENCE'
AND TEST_SUBGROUP = 'science'
AND LOCAL_SCHOOL_YEAR = '2014-2015' 
)
--select * from SCIENCE_2014
,SPANISH_2014
AS
(
SELECT DISTINCT ---SIS_SCHOOL_YEAR
    SIS_SCHOOL_YEAR AS 'School Year'
       ,STUD.STUDENT_ID AS 'Student APS ID'
       ,SDET.STUDENT_STATE_ID AS 'Student STATE_ID'
    ,TEST_PRIMARY_RESULT AS 'Spanish Overall Performance Level'
    ,CAST(TEST_SCALED_SCORE AS INT) AS 'Spanish Scale Score'
       ,TEST_NAME
       ,TEST_PRODUCT
       ,TEST_GROUP
       ,TEST_SUBGROUP
       ,TEST_RAW_SCORE
       ,TEST_HIGHEST_SCORE_INDICATOR
       ,TEST_LATEST_SCORE_INDICATOR
FROM K12INTEL_DW.FTBL_TEST_SCORES
INNER JOIN K12INTEL_DW.DTBL_TESTS
ON DTBL_TESTS.TESTS_KEY = FTBL_TEST_SCORES.TESTS_KEY 
INNER JOIN K12INTEL_DW.DTBL_STUDENTS STUD
ON STUD.STUDENT_KEY = FTBL_TEST_SCORES.STUDENT_KEY 
INNER JOIN K12INTEL_DW.DTBL_SCHOOLS
ON DTBL_SCHOOLS.SCHOOL_KEY = FTBL_TEST_SCORES.SCHOOL_KEY
INNER JOIN K12INTEL_DW.DTBL_CALENDAR_DATES
ON DTBL_CALENDAR_DATES.CALENDAR_DATE_KEY= FTBL_TEST_SCORES.CALENDAR_DATE_KEY
INNER JOIN K12INTEL_DW.DTBL_SCHOOL_DATES
ON DTBL_SCHOOL_DATES.SCHOOL_DATES_KEY = FTBL_TEST_SCORES.SCHOOL_DATES_KEY 
JOIN
[K12INTEL_DW].[DTBL_STUDENT_DETAILS] AS SDET
ON SDET.STUDENT_ID = STUD.STUDENT_ID
WHERE 
1 = 1
AND TEST_PRODUCT = 'SBA-NM'
AND TEST_SUBGROUP = 'READING(S)'
--AND TEST_SUBGROUP = 'Total Reading(S)'
AND LOCAL_SCHOOL_YEAR = '2014-2015' 
)
--SELECT * FROM SPANISH_2014
,RESULTS
AS
(
SELECT 	
	S14.[Student APS ID],
	'Science' as SUBJECT,
	S14.[Science Overall Performance Level] AS PERF_LEVEL,
	S14.[Science Scale Score] AS SCALED_SCORE
FROM	
	SCIENCE_2014 S14
union all
select
	SP14.[Student APS ID],
	'Spanish',
	SP14.[Spanish Overall Performance Level] AS SPANISH_2014_PERF_LEVEL,
	SP14.[Spanish Scale Score] AS SPANISH_2014_SCALED_SCORE
from
	SPANISH_2014 SP14
)
select * from results
--SELECT * INTO DBO.SBA_2015 FROM RESULTS

