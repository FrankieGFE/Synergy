BEGIN TRAN
/*
DELETE FROM
    [rev].[EPC_STU_CLASS]
*/
SELECT
    [Org].[ORGANIZATION_NAME]
    ,[Student].[SIS_NUMBER]
    ,[Course].[COURSE_ID]
    ,[Course].[COURSE_TITLE]
    ,[Section].[SECTION_ID]
    ,[Class].[ENTER_DATE]
    ,[Class].[LEAVE_DATE]
FROM
    [rev].[EPC_STU_CLASS] AS [Class]

    INNER JOIN
    [rev].[EPC_STU_SCH_YR] AS [SSY]
    ON
    [Class].[STUDENT_SCHOOL_YEAR_GU]=[SSY].[STUDENT_SCHOOL_YEAR_GU]

    INNER JOIN
    [rev].[EPC_STU] AS [Student]
    ON
    [SSY].[STUDENT_GU]=[Student].[STUDENT_GU]

    INNER JOIN
    rev.REV_ORGANIZATION_YEAR AS OrgYear
    ON
    SSY.ORGANIZATION_YEAR_GU = OrgYear.ORGANIZATION_YEAR_GU

    INNER JOIN
    [rev].[EPC_SCH_YR_SECT] AS [Section]
    ON
    [Class].[SECTION_GU]=[Section].[SECTION_GU]

    INNER JOIN
    [rev].[EPC_SCH_YR_CRS] AS [SYCourse]
    ON
    [Section].[SCHOOL_YEAR_COURSE_GU]=[SYCourse].[SCHOOL_YEAR_COURSE_GU]

    INNER JOIN
    [rev].[EPC_CRS] AS [Course]
    ON
    [SYCourse].[COURSE_GU]=[Course].[COURSE_GU]

    INNER JOIN
    rev.REV_ORGANIZATION AS Org
    ON
    OrgYear.ORGANIZATION_GU = Org.ORGANIZATION_GU

WHERE
    [Class].[ENTER_DATE] BETWEEN '2015-01-01' AND '2015-01-31'
    AND [Class].[LEAVE_DATE]=[Class].[ENTER_DATE]
    


SELECT
    [Org].[ORGANIZATION_NAME]
    ,[Student].[SIS_NUMBER]
    --,[Student].[STUDENT_GU]
    ,[Course].[COURSE_ID]
    ,[Course].[COURSE_TITLE]
    ,[Section].[SECTION_ID]
    ,[Class].[ENTER_DATE]
    ,[Class].[LEAVE_DATE]
    --,[Class].[SECTION_GU]
    --,ROW_NUMBER() OVER (PARTITION BY [Student].[STUDENT_GU],[Class].[SECTION_GU] ORDER BY [Class].[ENTER_DATE]) AS [RN]
/*UPDATE
    [Class]

SET
    [ENTER_DATE]='2015-01-05'
    ,[CHANGE_ID_STAMP]='D31C8E29-6CFB-43BB-B597-AA36480983F2'
    ,[CHANGE_DATE_TIME_STAMP]=CAST(GETDATE() AS DATE)*/
FROM
    [rev].[EPC_STU_CLASS] AS [Class]

    INNER JOIN
    [rev].[EPC_STU_SCH_YR] AS [SSY]
    ON
    [Class].[STUDENT_SCHOOL_YEAR_GU]=[SSY].[STUDENT_SCHOOL_YEAR_GU]

    INNER JOIN
    [rev].[EPC_STU] AS [Student]
    ON
    [SSY].[STUDENT_GU]=[Student].[STUDENT_GU]

    INNER JOIN
    rev.REV_ORGANIZATION_YEAR AS OrgYear
    ON
    SSY.ORGANIZATION_YEAR_GU = OrgYear.ORGANIZATION_YEAR_GU

    INNER JOIN
    [rev].[EPC_SCH_YR_SECT] AS [Section]
    ON
    [Class].[SECTION_GU]=[Section].[SECTION_GU]

    INNER JOIN
    [rev].[EPC_SCH_YR_CRS] AS [SYCourse]
    ON
    [Section].[SCHOOL_YEAR_COURSE_GU]=[SYCourse].[SCHOOL_YEAR_COURSE_GU]

    INNER JOIN
    [rev].[EPC_CRS] AS [Course]
    ON
    [SYCourse].[COURSE_GU]=[Course].[COURSE_GU]

    INNER JOIN
    rev.REV_ORGANIZATION AS Org
    ON
    OrgYear.ORGANIZATION_GU = Org.ORGANIZATION_GU

WHERE
    [Class].[ENTER_DATE] BETWEEN '2015-01-07' AND '2015-01-31'
    --AND [Class].[ENTER_DATE]!='2015-01-05'
    --AND [Class].[ENTER_DATE]!=ISNULL([Class].[LEAVE_DATE],'')
    AND [Org].[ORGANIZATION_NAME] NOT LIKE '%ecademy%'
    AND [Class].[LEAVE_DATE] IS NULL
    --AND [Student].[SIS_NUMBER]=101811958
    --AND [Class].[SECTION_GU] IN ('1b55a5ea-255a-4457-b3a6-123dbbec26c4', '6fb145f4-94f7-4d9d-9263-768d32605d8a')
    /*AND [Student].[STUDENT_GU] NOT IN ('D3A98F59-8EC6-414C-B52C-573E5ADBA4C3'
,'ED244DB8-9071-4F35-9DE6-81A4708A73B1'
,'0A286E17-C4CB-4B1D-A03A-A02068A912B4'
,'53947966-60C3-491A-9E7E-F9B957BD2801'
,'3D485BE1-D748-4197-833A-1540C5E0ACD9'
,'3D3337E9-CC5A-4571-9F7C-2DFDDC64A063'
,'731BEB3F-C09D-426F-8105-DFB52A656358'
,'0657CF50-C9AB-4668-B2BA-F2409AF86C35'
,'5078EBA7-5E71-482F-85CC-21926C90B580'
,'997F6366-F743-46D7-8AC8-88915A98661E'
,'30EF6895-6BCE-49F5-8501-31755E6C8404'
,'8DF528F7-5F6E-4523-951E-8692EDE2B089'
,'894C7E8F-D56C-4051-BECC-FF980A2E9294'
,'97B6ACFE-EC27-4694-97DC-8E85B6905611'
,'F37D2D1D-4E3F-4B3D-BB70-855F1A1EFF30')*/

/*) AS [Classes]
  
WHERE
    [Classes].[RN]>1
ORDER BY
    [Classes].[SIS_NUMBER]
    --,[Class].[SECTION_GU]*/

ROLLBACK