



EXECUTE AS LOGIN='QueryFileUser'
GO

	SELECT
		*
	FROM
		(
		SELECT
			[FILE].*
			,[ENROLLMENT].[LEAVE_DATE]
			,[ENROLLMENT].[LEAVE_CODE]
			,[ENROLLMENT].[LEAVE_DESCRIPTION]
			,[STU].[GRADUATION_DATE]
			--,[STU].[GRADUATION_PLAN]
			,[STU].[GRADUATION_SEMESTER]
			,[STU].[GRADUATION_STATUS]
			,[STU].[EXPECTED_GRADUATION_YEAR]
			,[GRADUATION_STATUS].[VALUE_DESCRIPTION] AS [GRAD_STATUS_DESCRIPTION]
			,[EARNED_CREDITS].[TOTAL_CREDITS]
			,ROW_NUMBER() OVER (PARTITION BY [ENROLLMENT].[STUDENT_GU] ORDER BY [ENROLLMENT].[ENTER_DATE] DESC) AS RN
		FROM
			OPENROWSET (
				'Microsoft.ACE.OLEDB.12.0', 
				'Text;Database=\\SynTempSSIS\Files\TempQuery\;',
				'SELECT * from EOY_Grad_Errors.csv' 
			)AS [FILE]
			
			INNER JOIN
			APS.BasicStudent AS [STUDENT]
			ON
			[FILE].[APS ID] = [STUDENT].[SIS_NUMBER]
			
			INNER JOIN
			rev.EPC_STU AS [STU]
			ON
			[STUDENT].[STUDENT_GU] = [STU].[STUDENT_GU]
			
			LEFT OUTER JOIN
			APS.LookupTable('K12','GRADUATION_STATUS') AS [GRADUATION_STATUS]
			ON
			[STU].[GRADUATION_STATUS] = [GRADUATION_STATUS].[VALUE_CODE]
			
			LEFT OUTER JOIN
			APS.StudentEnrollmentDetails AS [ENROLLMENT]
			ON
			[STUDENT].[STUDENT_GU] = [ENROLLMENT].[STUDENT_GU]
			AND [ENROLLMENT].[SCHOOL_YEAR] = '2014'
			AND [ENROLLMENT].[EXTENSION] = 'R'
			
			LEFT OUTER JOIN
			(
			SELECT
				[HISTORY].[STUDENT_GU]
				,SUM([HISTORY].[CREDIT_COMPLETED]) AS [TOTAL_CREDITS]
				
			FROM
				rev.[EPC_STU_CRS_HIS] AS [HISTORY]
				
				LEFT OUTER JOIN
				APS.LookupTable('K12','Grade') AS [Grades]
				ON
				[HISTORY].[GRADE] = [Grades].[VALUE_CODE]
				
			WHERE
				[Grades].[VALUE_DESCRIPTION] >= '09'
				AND ([HISTORY].[REPEAT_TAG_GU] != '92E81AF7-962A-4D66-ADF9-5FD3FD88FA7D' OR [HISTORY].[REPEAT_TAG_GU] IS NULL)
				
			GROUP BY
				[HISTORY].[STUDENT_GU]
			) AS [EARNED_CREDITS]
			ON
			[STUDENT].[STUDENT_GU] = [EARNED_CREDITS].[STUDENT_GU]
			
		) AS SUB1
		
	WHERE
		RN = 1
		--AND [LEAVE_DATE] IS NOT NULL
		--AND [APS ID] = '103414074'whats 
		
REVERT
GO