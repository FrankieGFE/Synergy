



EXECUTE AS LOGIN='QueryFileUser'
GO

	SELECT
		[FILE].*
		--,[STUDENT].*
		,[FRMHistory].[FRM_CODE] AS [LUNCH]
		
	FROM
		OPENROWSET (
			'Microsoft.ACE.OLEDB.12.0', 
			'Text;Database=\\SynTempSSIS\Files\TempQuery\;',
			'SELECT * from 2014_AP_Course_Schedules_108014_40Day.csv' 
		)AS [FILE]
		
	LEFT OUTER JOIN
	APS.BasicStudent AS [STUDENT]
	ON
	[FILE].[SIS_NUMBER] = [STUDENT].[SIS_NUMBER]
	
	LEFT JOIN
    (
	SELECT
		  ROW_NUMBER() OVER (PARTITION BY [STU].[STUDENT_GU] order by [FRM].[ENTER_DATE],[STU].[STUDENT_GU]) [RN]
		, [STU].[STUDENT_GU]
		, [FRM].[FRM_CODE]
	FROM 
		rev.EPC_STU [STU]
		
		LEFT JOIN 
		rev.EPC_STU_PGM_FRM_HIS [FRM] 
		ON
		[FRM].[STUDENT_GU] = [STU].[STUDENT_GU]
		AND [FRM].[ENTER_DATE] IS NOT NULL 
		AND ([FRM].[EXIT_DATE] IS NOT NULL OR [FRM].[EXIT_DATE] > GETDATE())
	) AS [FRMHistory]
	ON
	[STUDENT].[STUDENT_GU] = [FRMHistory].[STUDENT_GU]
	AND [FRMHistory].[RN] = 1		
	
REVERT
GO