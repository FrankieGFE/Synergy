



SELECT
	'2014-2015' AS [SCHOOL_YEAR]
	,'SPRING' AS [SEMESTER]
	,[STUDENT].[SIS_NUMBER]
	,[STUDENT].[STATE_STUDENT_NUMBER]
	--,[ENROLLMENTS].[SCHOOL_YEAR]
	,[ENROLLMENTS].[SCHOOL_CODE]
	
	,[COURSE_HISTORY].[TERM_CODE]
	,[COURSE_HISTORY].[COURSE_ID]
	,[COURSE_HISTORY].[COURSE_TITLE]
	,[COURSE].[DEPARTMENT]	
	
	--,'COURSE HISTORY/TRANSCRIPT' AS [TYPE]
	,[COURSE].[SUBJECT_AREA_1]
	,[COURSE].[SUBJECT_AREA_2]
	,[COURSE].[SUBJECT_AREA_3]
	,[COURSE].[SUBJECT_AREA_4]
	,[COURSE].[SUBJECT_AREA_5]
	,[COURSE_HISTORY].[MARK] AS [GRADE]
	
FROM
	(
	SELECT
		*
		,ROW_NUMBER() OVER (PARTITION BY [ENROLLMENTS].[STUDENT_GU] ORDER BY [ENROLLMENTS].[ENTER_DATE] DESC) AS RN
	FROM
		APS.StudentEnrollmentDetails AS [ENROLLMENTS]
		
	WHERE
		[ENROLLMENTS].[SCHOOL_CODE] IN ('255','260','279','270','285','333','379','410','413','416','425','460','470','520','540','570','576')
		AND [ENROLLMENTS].[SCHOOL_YEAR] = '2014'
		AND [ENROLLMENTS].[EXTENSION] = 'R'
		AND [ENROLLMENTS].[ENTER_DATE] IS NOT NULL
		AND ([ENROLLMENTS].[LEAVE_DATE] IS NULL OR [ENROLLMENTS].[LEAVE_DATE] > '01/01/2015')
	) AS [ENROLLMENTS]
	
	INNER JOIN
	APS.BasicStudentWithMoreInfo AS [STUDENT]
	ON
	[ENROLLMENTS].[STUDENT_GU] = [STUDENT].[STUDENT_GU]
	
	INNER JOIN
	rev.[EPC_STU_CRS_HIS] AS [COURSE_HISTORY]
	ON
	[ENROLLMENTS].[STUDENT_GU] = [COURSE_HISTORY].[STUDENT_GU]
	AND [COURSE_HISTORY].[SCHOOL_YEAR] = '2014'
	
	LEFT OUTER JOIN
	-- Get Course details
	rev.EPC_CRS AS [COURSE]
	ON
	[COURSE_HISTORY].[COURSE_GU] = [COURSE].[COURSE_GU]
	
WHERE
	[ENROLLMENTS].[RN] = 1
	AND [COURSE_HISTORY].[TERM_CODE] NOT IN ('S1','T1')
	AND [COURSE].[DEPARTMENT] IN ('Math','Eng','Soc','Sci')
	
ORDER BY
	[STUDENT].[SIS_NUMBER]