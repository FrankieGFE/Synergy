


; WITH 
-- From Student School Year [EPC_STU_SCH_YR]
SSY_ENROLLMENTS AS
(
SELECT
	[StudentSchoolYear].[STUDENT_GU]
	,[StudentSchoolYear].[ORGANIZATION_YEAR_GU]
	,[Organization].[ORGANIZATION_GU]
	,[Grades].[VALUE_DESCRIPTION] AS [GRADE]
	,[Grades].[LIST_ORDER]
	,[School].[SCHOOL_CODE]
	,[Organization].[ORGANIZATION_NAME] AS [SCHOOL_NAME]
	,[StudentSchoolYear].[ENTER_DATE]
	,[StudentSchoolYear].[LEAVE_DATE]
	,[StudentSchoolYear].[LEAVE_CODE]
	,[StudentSchoolYear].[EXCLUDE_ADA_ADM]
	,[StudentSchoolYear].[ACCESS_504]
	,CASE WHEN [StudentSchoolYear].[EXCLUDE_ADA_ADM] = 2 THEN 'CONCURRENT'
		WHEN [StudentSchoolYear].[EXCLUDE_ADA_ADM] = 1 THEN 'NO ADA/ADM'
		ELSE '' END AS [CONCURRENT]
	,[RevYear].[SCHOOL_YEAR]
	,[RevYear].[EXTENSION]
	,ROW_NUMBER() OVER (PARTITION BY [StudentSchoolYear].[STUDENT_GU] ORDER BY [StudentSchoolYear].[ENTER_DATE] DESC) AS [RN]
FROM
	rev.EPC_STU_SCH_YR AS [StudentSchoolYear]
	
	INNER JOIN 
	rev.REV_ORGANIZATION_YEAR AS [OrgYear] -- Links between School and Year
	ON 
	[StudentSchoolYear].[ORGANIZATION_YEAR_GU] = [OrgYear].[ORGANIZATION_YEAR_GU]
	
	INNER JOIN 
	rev.REV_ORGANIZATION AS [Organization] -- Contains the School Name
	ON 
	[OrgYear].[ORGANIZATION_GU] = [Organization].[ORGANIZATION_GU]
	
	INNER JOIN 
	rev.REV_YEAR AS [RevYear] -- Contains the School Year
	ON 
	[OrgYear].[YEAR_GU] = [RevYear].[YEAR_GU]
	
	LEFT OUTER JOIN
	APS.LookupTable('K12','Grade') AS [Grades]
	ON
	[StudentSchoolYear].[GRADE] = [Grades].[VALUE_CODE]
	
	INNER JOIN 
	rev.EPC_SCH AS [School] -- Contains the School Code / Number
	ON 
	[Organization].[ORGANIZATION_GU] = [School].[ORGANIZATION_GU]
	
WHERE
	--[StudentSchoolYear].[EXCLUDE_ADA_ADM] IS NULL
	[RevYear].[SCHOOL_YEAR] = '2014'
	AND [RevYear].[EXTENSION] = 'R'

)


SELECT
	'2014-2015' AS [SCHOOL_YEAR]
	,'FALL' AS [SEMESTER]
	,[STUDENT].[SIS_NUMBER]
	,[STUDENT].[STATE_STUDENT_NUMBER]
	,[PERSON].[FIRST_NAME]
	,[PERSON].[LAST_NAME]
	,[PERSON].[MIDDLE_NAME]
	--,[PERSON].[BIRTH_DATE]
	,[ENROLLMENTS].[GRADE]
	,[ENROLLMENTS].[SCHOOL_CODE]
	,[ENROLLMENTS].[SCHOOL_NAME]
	,[ENROLLMENTS].[ENTER_DATE]
	,[ENROLLMENTS].[LEAVE_DATE]
	,[ENROLLMENTS].[LEAVE_CODE]
	,[LEAVE_CODE].[VALUE_DESCRIPTION] AS [LEAVE_DESCRIPTION]
	
	,[REQUEST_TRACKING].[PERSON_RELEASED_TO]
	,[REQUEST_TRACKING].[RELEASE_DATE]
	,[REQUEST_TRACKING].[RELEASE_PURPOSE]
	,[RELEASE_PURPOSE].[VALUE_DESCRIPTION]
	,[NON_DISTRICT_SCHOOL].[NAME] AS [NON_DISTRICT_NAME]
	
	
FROM
	SSY_ENROLLMENTS AS [ENROLLMENTS]
	
	INNER JOIN
	rev.EPC_STU AS [STUDENT]
	ON
	[ENROLLMENTS].[STUDENT_GU] = [STUDENT].[STUDENT_GU]
	
	INNER JOIN
	rev.REV_PERSON AS [PERSON]
	ON
	[ENROLLMENTS].[STUDENT_GU] = [PERSON].[PERSON_GU]
	
	LEFT JOIN
	rev.[EPC_STU_REQUEST_TRACKING] AS [REQUEST_TRACKING]
	ON
	[ENROLLMENTS].[STUDENT_GU] = [REQUEST_TRACKING].[STUDENT_GU]
	
	LEFT JOIN 
	rev.[EPC_SCH_NON_DST] AS [NON_DISTRICT_SCHOOL] -- Contains the School Name
	ON 
	[REQUEST_TRACKING].[SCHOOL_NON_DISTRICT_GU] = [NON_DISTRICT_SCHOOL].[SCHOOL_NON_DISTRICT_GU]
	
	LEFT JOIN
	APS.LookupTable('K12.CourseHistoryInfo','RELEASE_PURPOSE') AS [RELEASE_PURPOSE]
	ON
	[REQUEST_TRACKING].[RELEASE_PURPOSE] = [RELEASE_PURPOSE].[VALUE_CODE]
	
	LEFT JOIN
	APS.LookupTable('K12','LEAVE_CODE') AS [LEAVE_CODE]
	ON
	[ENROLLMENTS].[LEAVE_CODE] = [LEAVE_CODE].[VALUE_CODE]
	
WHERE
	--[ENROLLMENTS].[RN] = 1
	[ENROLLMENTS].[ENTER_DATE] IS NOT NULL
	AND
	[ENROLLMENTS].[ENTER_DATE] <= '12/19/2014'
	AND
	( 
	[ENROLLMENTS].[LEAVE_DATE] IS NULL
	OR
	[ENROLLMENTS].[LEAVE_DATE] <= '12/19/2014'
	)
	--OR
	--([ENROLLMENTS].[ENTER_DATE] > '08/13/2014' AND [ENROLLMENTS].[ENTER_DATE] <= '12/19/2014')
	
	--AND [ENROLLMENTS].[ENTER_DATE] = '12/19/2014'
	
	
ORDER BY
	[PERSON].[LAST_NAME]
	,[PERSON].[FIRST_NAME]
	
	
--SELECT TOP 100
--	*
--FROM
--	rev.[EPC_STU_REQUEST_TRACKING]
	--APS.LookupTable('K12.CourseHistoryInfo','RELEASE_PURPOSE') 
--	rev.REV_BOD_LOOKUP_DEF
	--rev.EPC_SCH_NON_DST
	
--WHERE
--	LOOKUP_DEF_CODE LIKE '%REL%'