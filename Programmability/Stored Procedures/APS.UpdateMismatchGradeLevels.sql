
/*
*	CREATED BY: DEBBIE ANN CHAVEZ
*	DATE: 4/19/2016
*
*  NIGHTLY PROCESS TO MAKE SURE ALL GRADE LEVELS IN OPEN ENROLLMENTS MATCH THE SSY GRADE LEVEL.
*
*	UPDATES rev.EPC_STU_SCH_YR, rev.EPC_STU_ENROLL, and rev.EPC_STU_ENROLL_ACTIVITY
*	
*/

USE ST_Production
GO


-- Remove Procedure if it exists
IF  NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[APS].[UpdateMismatchGradeLevels]') AND type in (N'P', N'PC'))
	EXEC ('CREATE PROCEDURE [APS].UpdateMismatchGradeLevels AS SELECT 0')
GO


ALTER PROC [APS].[UpdateMismatchGradeLevels]

(
	@ValidateOnly INT
)


AS
BEGIN

BEGIN TRANSACTION

/*===============================================================================

--UPDATES THE ENROLL TABLE FOR OPEN PRIMARY ENROLLMENTS ONLY FROM THE SSY OPEN ENROLLMENT
--UPDATES ONLY WHERE GRADE DOES NOT MATCH
================================================================================*/

UPDATE REV.EPC_STU_ENROLL

SET GRADE = LU_GRADE

FROM 

(

SELECT 
	SIS_NUMBER, PRIMARIES.GRADE AS SSY_PRIMARY_GRADE,  ENROLLS.GRADE AS ENROLL_GRADE 
	,PRIMARIES.LU_GRADE, ENROLLS.LU_GRADE2, PRIMARIES.STUDENT_SCHOOL_YEAR_GU, ORGANIZATION_NAME

 FROM 
(SELECT STUDENT_GU, LU.VALUE_DESCRIPTION AS GRADE, STUDENT_SCHOOL_YEAR_GU
,LU.VALUE_CODE AS LU_GRADE, ORGANIZATION_NAME

 FROM APS.PrimaryEnrollmentsAsOf(GETDATE()) AS PRIM
INNER JOIN 
APS.LookupTable('K12', 'GRADE') AS LU
ON
PRIM.GRADE = LU.VALUE_CODE

INNER JOIN 
rev.REV_ORGANIZATION_YEAR AS ORGYR
ON
PRIM.ORGANIZATION_YEAR_GU = ORGYR.ORGANIZATION_YEAR_GU
INNER JOIN 
rev.REV_ORGANIZATION AS ORG
ON
ORGYR.ORGANIZATION_GU = ORG.ORGANIZATION_GU

) AS PRIMARIES

INNER JOIN 

(SELECT VALUE_DESCRIPTION AS GRADE, STUDENT_SCHOOL_YEAR_GU, ENROLL.GRADE AS LU_GRADE2  

FROM 
	REV.EPC_STU_ENROLL AS ENROLL

	INNER JOIN 
APS.LookupTable('K12', 'GRADE') AS LU
ON
ENROLL.GRADE = LU.VALUE_CODE
	
) AS ENROLLS

ON
ENROLLS.STUDENT_SCHOOL_YEAR_GU = PRIMARIES.STUDENT_SCHOOL_YEAR_GU

INNER JOIN 
rev.EPC_STU AS STU
ON
PRIMARIES.STUDENT_GU = STU.STUDENT_GU

WHERE
ENROLLS.GRADE != PRIMARIES.GRADE
AND  PRIMARIES.GRADE NOT IN  ('PK', 'P1', 'P2')

) AS SSYFIX

WHERE
SSYFIX.STUDENT_SCHOOL_YEAR_GU = rev.EPC_STU_ENROLL.STUDENT_SCHOOL_YEAR_GU
AND SSYFIX.LU_GRADE != rev.EPC_STU_ENROLL.GRADE

--------------------------------------------------------------------------------------------------------------------------------------------
/*===============================================================================================

--UPDATES THE ENROLL_ACTIVITY TABLE FOR OPEN PRIMARY ENROLLMENTS ONLY FROM THE SSY OPEN ENROLLMENT
--UPDATES ONLY WHERE GRADE DOES NOT MATCH
==================================================================================================*/

UPDATE REV.EPC_STU_ENROLL_ACTIVITY

SET GRADE = LU_GRADE

FROM 

(

SELECT 
	SIS_NUMBER, PRIMARIES.GRADE AS SSY_PRIMARY_GRADE,  ENROLLS.GRADE AS ENROLL_GRADE, ACTIVITY_GRADE 
	,PRIMARIES.LU_GRADE, ENROLLS.LU_GRADE2, PRIMARIES.ENROLLMENT_GU, ORGANIZATION_NAME

 FROM 
(SELECT STUDENT_GU, LU.VALUE_DESCRIPTION AS GRADE, STUDENT_SCHOOL_YEAR_GU
,LU.VALUE_CODE AS LU_GRADE, PRIM.ENROLLMENT_GU, ORGANIZATION_NAME

 FROM APS.PrimaryEnrollmentsAsOf(GETDATE()) AS PRIM
INNER JOIN 
APS.LookupTable('K12', 'GRADE') AS LU
ON
PRIM.GRADE = LU.VALUE_CODE

INNER JOIN 
rev.REV_ORGANIZATION_YEAR AS ORGYR
ON
PRIM.ORGANIZATION_YEAR_GU = ORGYR.ORGANIZATION_YEAR_GU
INNER JOIN 
rev.REV_ORGANIZATION AS ORG
ON
ORGYR.ORGANIZATION_GU = ORG.ORGANIZATION_GU
) AS PRIMARIES

INNER JOIN 

(SELECT LU.VALUE_DESCRIPTION AS GRADE, STUDENT_SCHOOL_YEAR_GU, ACT.GRADE AS LU_GRADE2
,ENROLL.ENROLLMENT_GU, LU2.VALUE_DESCRIPTION AS ACTIVITY_GRADE 

FROM 
	REV.EPC_STU_ENROLL AS ENROLL

	INNER JOIN 
APS.LookupTable('K12', 'GRADE') AS LU
ON
ENROLL.GRADE = LU.VALUE_CODE

INNER JOIN 
rev.EPC_STU_ENROLL_ACTIVITY AS ACT
ON
ENROLL.ENROLLMENT_GU = ACT.ENROLLMENT_GU

INNER JOIN 
APS.LookupTable('K12', 'GRADE') AS LU2
ON
ACT.GRADE = LU2.VALUE_CODE
	
) AS ENROLLS

ON
ENROLLS.ENROLLMENT_GU = PRIMARIES.ENROLLMENT_GU

INNER JOIN 
rev.EPC_STU AS STU
ON
PRIMARIES.STUDENT_GU = STU.STUDENT_GU

WHERE
ENROLLS.LU_GRADE2 != PRIMARIES.LU_GRADE
AND  PRIMARIES.GRADE NOT IN ('PK', 'P1', 'P2')

) AS SSYFIX

WHERE
SSYFIX.ENROLLMENT_GU= rev.EPC_STU_ENROLL_ACTIVITY.ENROLLMENT_GU
AND SSYFIX.LU_GRADE != rev.EPC_STU_ENROLL_ACTIVITY.GRADE

----------------------------------------------------------------------------------------------------------------------------------------------
/*===============================================================================================
--UPDATES THE SSY TABLE FOR NON PRIMARY OPEN ENROLLMENTS FROM THE SSY OPEN PRIMARY ENROLLMENT
==================================================================================================*/

UPDATE REV.EPC_STU_SCH_YR

SET GRADE = SSYFIX.SSY_LU_GRADE

FROM 

(

SELECT 
	STU.SIS_NUMBER, PRIMARIES.GRADE AS SSY_PRIMARY_GRADE,  SSYADAS.GRADE AS SSY_ADAS_GRADE,
	PRIMARIES.LU_GRADE AS SSY_LU_GRADE, SSYADAS.LU_GRADE AS SSYADAS_LU_GRADE, SSYADAS.STUDENT_SCHOOL_YEAR_GU, ORGANIZATION_NAME AS PRIM, Non_Primary_school

 FROM 
(SELECT STUDENT_GU, LU.VALUE_DESCRIPTION AS GRADE, STUDENT_SCHOOL_YEAR_GU
,LU.VALUE_CODE AS LU_GRADE, PRIM.ENROLLMENT_GU, ORGANIZATION_NAME

 FROM APS.PrimaryEnrollmentsAsOf(GETDATE()) AS PRIM
INNER JOIN 
APS.LookupTable('K12', 'GRADE') AS LU
ON
PRIM.GRADE = LU.VALUE_CODE


INNER JOIN 
rev.REV_ORGANIZATION_YEAR AS ORGYR
ON
PRIM.ORGANIZATION_YEAR_GU = ORGYR.ORGANIZATION_YEAR_GU
INNER JOIN 
rev.REV_ORGANIZATION AS ORG
ON
ORGYR.ORGANIZATION_GU = ORG.ORGANIZATION_GU

) AS PRIMARIES


--GET SECONDARY ENROLLMENTS
INNER JOIN 
 (SELECT * FROM  APS.OpenNonPrimaryEnrollments 
 WHERE Primary_School IS NOT NULL)
 
 AS SSYADAS

ON
SSYADAS.STUDENT_GU = PRIMARIES.STUDENT_GU

INNER JOIN 
rev.EPC_STU AS STU
ON
PRIMARIES.STUDENT_GU = STU.STUDENT_GU


WHERE
SSYADAS.LU_GRADE != PRIMARIES.LU_GRADE
AND  PRIMARIES.GRADE NOT IN ('PK', 'P1', 'P2')


) AS SSYFIX

WHERE

rev.EPC_STU_SCH_YR.STUDENT_SCHOOL_YEAR_GU = SSYFIX.STUDENT_SCHOOL_YEAR_GU
----------------------------------------------------------------------------------------------------------------------------------------------

/*===============================================================================================
--UPDATES THE ENROLL TABLE FOR NON PRIMARY OPEN ENROLLMENTS FROM THE SSY OPEN PRIMARY ENROLLMENT
==================================================================================================*/

UPDATE REV.EPC_STU_ENROLL

SET GRADE = SSYFIX.SSY_LU_GRADE

FROM 

(


SELECT 
	STU.SIS_NUMBER, PRIMARIES.GRADE AS SSY_PRIMARY_GRADE,  ENROLLS.GRADE AS ENROLL_ADAS_GRADE,
	PRIMARIES.LU_GRADE AS SSY_LU_GRADE, ENROLLS.LU_GRADE2 AS ENROLL_LU_GRADE, ENROLLS.STUDENT_SCHOOL_YEAR_GU, ENROLLS.ENROLLMENT_GU, PRIMARIES.ORGANIZATION_NAME, Non_Primary_School

 FROM 
(SELECT STUDENT_GU, LU.VALUE_DESCRIPTION AS GRADE, STUDENT_SCHOOL_YEAR_GU
,LU.VALUE_CODE AS LU_GRADE, PRIM.ENROLLMENT_GU, ORGANIZATION_NAME

 FROM APS.PrimaryEnrollmentsAsOf(GETDATE()) AS PRIM
INNER JOIN 
APS.LookupTable('K12', 'GRADE') AS LU
ON
PRIM.GRADE = LU.VALUE_CODE

INNER JOIN 
rev.REV_ORGANIZATION_YEAR AS ORGYR
ON
PRIM.ORGANIZATION_YEAR_GU = ORGYR.ORGANIZATION_YEAR_GU
INNER JOIN 
rev.REV_ORGANIZATION AS ORG
ON
ORGYR.ORGANIZATION_GU = ORG.ORGANIZATION_GU

) AS PRIMARIES


--GET SECONDARY ENROLLMENTS
INNER JOIN 
 (SELECT * FROM  APS.OpenNonPrimaryEnrollments 
 WHERE Primary_School IS NOT NULL)
 
 AS SSYADAS

ON
SSYADAS.STUDENT_GU = PRIMARIES.STUDENT_GU

INNER JOIN 
rev.EPC_STU AS STU
ON
PRIMARIES.STUDENT_GU = STU.STUDENT_GU
------------------------------------------------------------------------------------------------------

-- GET ENROLL RECORD
INNER JOIN 
(SELECT VALUE_DESCRIPTION AS GRADE, STUDENT_SCHOOL_YEAR_GU, ENROLL.GRADE AS LU_GRADE2, ENROLLMENT_GU  

FROM 
	REV.EPC_STU_ENROLL AS ENROLL

	INNER JOIN 
APS.LookupTable('K12', 'GRADE') AS LU
ON
ENROLL.GRADE = LU.VALUE_CODE
	
) AS ENROLLS

ON
ENROLLS.STUDENT_SCHOOL_YEAR_GU = SSYADAS.STUDENT_SCHOOL_YEAR_GU
----------------------------------------------------------------------------------------------------

WHERE
ENROLLS.LU_GRADE2 != PRIMARIES.LU_GRADE
AND  PRIMARIES.GRADE NOT IN ('PK', 'P1', 'P2')

) AS SSYFIX

WHERE
SSYFIX.ENROLLMENT_GU= rev.EPC_STU_ENROLL.ENROLLMENT_GU

----------------------------------------------------------------------------------------------------------------------------------------------
/*===============================================================================================
--UPDATES THE ENROLL_ACTIVITY TABLE FOR NON PRIMARY OPEN ENROLLMENTS FROM THE SSY OPEN PRIMARY ENROLLMENT
==================================================================================================*/
UPDATE REV.EPC_STU_ENROLL_ACTIVITY

SET GRADE = SSYFIX.SSY_LU_GRADE

FROM 

(


SELECT 
	STU.SIS_NUMBER, PRIMARIES.GRADE AS SSY_PRIMARY_GRADE
	,ENROLLS.GRADE AS ENROLL_ACTIVITY_ADAS_GRADE,
	PRIMARIES.LU_GRADE AS SSY_LU_GRADE, ENROLLS.LU_GRADE2 AS ENROLL_ACTIVITY_LU_GRADE, ENROLLS.STUDENT_SCHOOL_YEAR_GU, ENROLLS.ENROLLMENT_GU, ORGANIZATION_NAME, Non_Primary_School

 FROM 
(SELECT STUDENT_GU, LU.VALUE_DESCRIPTION AS GRADE, STUDENT_SCHOOL_YEAR_GU
,LU.VALUE_CODE AS LU_GRADE, PRIM.ENROLLMENT_GU, ORGANIZATION_NAME

 FROM APS.PrimaryEnrollmentsAsOf(GETDATE()) AS PRIM
INNER JOIN 
APS.LookupTable('K12', 'GRADE') AS LU
ON
PRIM.GRADE = LU.VALUE_CODE


INNER JOIN 
rev.REV_ORGANIZATION_YEAR AS ORGYR
ON
PRIM.ORGANIZATION_YEAR_GU = ORGYR.ORGANIZATION_YEAR_GU
INNER JOIN 
rev.REV_ORGANIZATION AS ORG
ON
ORGYR.ORGANIZATION_GU = ORG.ORGANIZATION_GU

) AS PRIMARIES


--GET SECONDARY ENROLLMENTS
INNER JOIN 
 (SELECT * FROM  APS.OpenNonPrimaryEnrollments 
 WHERE Primary_School IS NOT NULL)
 
 AS SSYADAS

ON
SSYADAS.STUDENT_GU = PRIMARIES.STUDENT_GU

INNER JOIN 
rev.EPC_STU AS STU
ON
PRIMARIES.STUDENT_GU = STU.STUDENT_GU
------------------------------------------------------------------------------------------------------

-- GET ENROLL ACTIVITY RECORD
INNER JOIN 

(SELECT LU2.VALUE_DESCRIPTION AS GRADE, STUDENT_SCHOOL_YEAR_GU, ACT.GRADE AS LU_GRADE2
,ENROLL.ENROLLMENT_GU, LU2.VALUE_DESCRIPTION AS ACTIVITY_GRADE 

FROM 
	REV.EPC_STU_ENROLL AS ENROLL

--	INNER JOIN 
--APS.LookupTable('K12', 'GRADE') AS LU
--ON
--ENROLL.GRADE = LU.VALUE_CODE

INNER JOIN 
rev.EPC_STU_ENROLL_ACTIVITY AS ACT
ON
ENROLL.ENROLLMENT_GU = ACT.ENROLLMENT_GU

INNER JOIN 
APS.LookupTable('K12', 'GRADE') AS LU2
ON
ACT.GRADE = LU2.VALUE_CODE
	
) AS ENROLLS

ON
ENROLLS.STUDENT_SCHOOL_YEAR_GU = SSYADAS.STUDENT_SCHOOL_YEAR_GU
----------------------------------------------------------------------------------------------------

WHERE
ENROLLS.LU_GRADE2 != PRIMARIES.LU_GRADE
AND  PRIMARIES.GRADE NOT IN ('PK', 'P1', 'P2')


) AS SSYFIX

WHERE
SSYFIX.ENROLLMENT_GU= rev.EPC_STU_ENROLL_ACTIVITY.ENROLLMENT_GU


----------------------------------------------------------------------------------------------------------------------------------------------

--Validation Check to see how many records will be processed, 0 = INSERT-WILL UPDATE, 1 = ROLLBACK-WILL NOT UPDATE
IF @ValidateOnly = 0
	BEGIN
		PRINT 'UPDATED Grade Levels'
		COMMIT 

	END
ELSE
	BEGIN
		PRINT 'Grade Levels NOT UPDATED'
		ROLLBACK
	END



END
GO

