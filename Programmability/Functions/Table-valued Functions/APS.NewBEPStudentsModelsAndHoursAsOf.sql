USE [ST_Production]
GO

/****** Object:  UserDefinedFunction [APS].[NewBEPStudentsModelsAndHoursAsOf]    Script Date: 10/3/2017 11:23:52 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER FUNCTION [APS].[NewBEPStudentsModelsAndHoursAsOf](@AsOfDate DATE)
RETURNS TABLE
AS
RETURN	


SELECT 
	
	SIS_NUMBER, 
	PRIM.SCHOOL_NAME, LAST_NAME, FIRST_NAME,
	EL,
	
	CASE 
		WHEN HIGHESTCOUNT = 1  THEN 1 
		WHEN HIGHESTCOUNT = 2 THEN 2	
		WHEN HIGHESTCOUNT >= 3 THEN 3
	ELSE '' END  AS [HOUR]


	,CASE 
		WHEN HIGHESTCOUNT = 1  THEN 'Heritage/Indigenous Language' 
		WHEN HIGHESTCOUNT = 2 THEN 'Heritage/Indigenous Language'
		WHEN HIGHESTCOUNT >= 3 AND FINISHUP.SCHOOL_CODE NOT IN ('206', '210', '213', '215', '216', '225', '339', '243', '244', '249', '252', '262', '255',
													'496', '285', '291', '300', '250', '327', '275', '333', '330', '392', '280', '370', '376', '379', '385', 
													'405', '415', '416', '475', '465', '470', '590', '576' )
								THEN 'Heritage/Indigenous Language'
		WHEN HIGHESTCOUNT >= 3 AND FINISHUP.SCHOOL_CODE IN ('206', '210', '213', '215', '216', '225', '339', '243', '244', '249', '252', '262', '255',
													'496', '285', '291', '300', '250', '327', '275', '333', '330', '392', '280', '370', '376', '379', '385', 
													'405', '415', '416', '475', '465', '470', '590', '576' )
								THEN '2-Way Dual'
		
	ELSE '' END AS MODEL

FROM 


(
SELECT 
	MAX(RN) AS HIGHESTCOUNT
	,STUDENT_GU, SIS_NUMBER, EL, SCHOOL_CODE
 FROM 
(
SELECT 
	SIS_NUMBER, STUDENT_GU, EL, SCHOOL_CODE
	,ROW_NUMBER() OVER (PARTITION BY SIS_NUMBER ORDER BY SIS_NUMBER) AS RN
FROM
		APS.NewBEPModelsAndHoursDetailsAsOf(@AsOfDate)
)AS COUNTME
	GROUP BY STUDENT_GU, SIS_NUMBER, EL, SCHOOL_CODE

) AS FINISHUP

INNER JOIN 
APS.PrimaryEnrollmentDetailsAsOf(@AsOfDate) AS PRIM
ON
FINISHUP.STUDENT_GU = PRIM.STUDENT_GU

INNER JOIN 
REV.REV_PERSON AS PERS
ON
PRIM.STUDENT_GU = PERS.PERSON_GU

GO


