USE [ST_Production]
GO

/****** Object:  UserDefinedFunction [APS].[LCEMostRecentALSRefusalAsOf]    Script Date: 10/19/2016 10:44:44 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



/*
*	Pull Most Recent LCE Refusal of ALS Services
*/

CREATE FUNCTION [APS].[LCEMostRecentALSRefusalAsOf](@AsOfDate DATETIME)
RETURNS TABLE
AS
RETURN

SELECT 
	STUDENT_GU
	,WAIVER_TYPE
	,WAIVER_ENTER_DATE
	,WAIVER_EXIT_DATE
FROM 
	(
	SELECT
		STUDENT_GU
		,WAIVER_TYPE
		,WAIVER_ENTER_DATE
		,WAIVER_EXIT_DATE
		--ORDER ALL OF THE WAIVERS BY MOST RECENT ENTER DATE
		 ,ROW_NUMBER() OVER (PARTITION BY STUDENT_GU ORDER BY WAIVER_ENTER_DATE DESC) AS RN
	 FROM
		rev.EPC_STU_PGM_ELL_WAV
	 WHERE
	 --THERE IS ONLY ONE TYPE OF REFUSAL CODE FOR REFUSAL OF ALS SERVICES
	 WAIVER_TYPE IN ('RALS')
	 AND @AsOfDate BETWEEN WAIVER_ENTER_DATE AND COALESCE (WAIVER_EXIT_DATE, @asOfDate)
	 AND WAIVER_GRADE IS NOT NULL 
	 AND WAIVER_STATUS IS NOT NULL 
	 AND WAIVER_STATUS_DATE IS NOT NULL 
	 
	 ) AS ALLWAIVERS

--PULL MOST RECENT TEST ASSESSMENT
WHERE
	RN = 1

GO


