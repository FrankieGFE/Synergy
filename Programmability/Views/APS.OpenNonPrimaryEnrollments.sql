/**
 * 
 * $CreatedBy: Debbie Ann Chavez
 * $Date: 4/14/2016 $
 */

/**/
IF NOT EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[APS].[OpenNonPrimaryEnrollments]'))
	EXEC ('CREATE VIEW APS.OpenNonPrimaryEnrollments AS SELECT 0 AS DUMMY')
GO

ALTER VIEW [APS].[OpenNonPrimaryEnrollments] AS

SELECT SIS_NUMBER, SCHOOL_YEAR, EXTENSION, VALUE_DESCRIPTION AS GRADE, ORG.ORGANIZATION_NAME AS Non_Primary_School, SSY.ENTER_DATE, SSY.LEAVE_DATE
,PRIMORG.ORGANIZATION_NAME AS Primary_School, STU.STUDENT_GU, SSY.STUDENT_SCHOOL_YEAR_GU, SSY.GRADE AS LU_GRADE
	
FROM 
(SELECT * FROM 
rev.EPC_STU_SCH_YR
WHERE
EXCLUDE_ADA_ADM IS NOT NULL
AND (LEAVE_DATE IS NULL OR LEAVE_DATE > GETDATE())
AND YEAR_GU = (SELECT * FROM rev.SIF_22_Common_CurrentYearGU)
) AS SSY

INNER JOIN
rev.REV_YEAR AS YEARS
ON
SSY.YEAR_GU = YEARS.YEAR_GU

INNER JOIN 
rev.EPC_STU AS STU
ON
SSY.STUDENT_GU = STU.STUDENT_GU


INNER JOIN 
rev.REV_ORGANIZATION_YEAR AS ORGYR
ON
ORGYR.ORGANIZATION_YEAR_GU = SSY.ORGANIZATION_YEAR_GU

INNER JOIN 
rev.REV_ORGANIZATION AS ORG
ON
ORGYR.ORGANIZATION_GU = ORG.ORGANIZATION_GU

INNER JOIN 
APS.LookupTable('K12', 'Grade') AS LU
ON
LU.VALUE_CODE = SSY.GRADE


LEFT JOIN 
APS.PrimaryEnrollmentsAsOf(GETDATE()) AS PRIM
ON
STU.STUDENT_GU = PRIM.STUDENT_GU

LEFT JOIN 
rev.REV_ORGANIZATION_YEAR AS PRIMORGYR
ON
PRIM.ORGANIZATION_YEAR_GU = PRIMORGYR.ORGANIZATION_YEAR_GU

LEFT JOIN 
rev.REV_ORGANIZATION AS PRIMORG
ON
PRIMORGYR.ORGANIZATION_GU = PRIMORG.ORGANIZATION_GU


