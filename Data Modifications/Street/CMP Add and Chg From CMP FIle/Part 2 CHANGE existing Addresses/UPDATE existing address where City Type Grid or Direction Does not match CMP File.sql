
/********************************************************************************************************************
	Created by Debbie Ann Chavez
	Date 7/29/2016
	
	THIS READS A FILE FROM CMP AND COMPARES GRID CODE, STREET TYPE, STREET POST DIRECTION AND CITY FOR ANY CHANGES
		

**********************************************************************************************************************/



EXECUTE AS LOGIN='QueryFileUser'
GO

BEGIN TRANSACTION


UPDATE rev.EPC_STREET 
SET CITY = T4.CITY, STREET_TYPE = T4.FILE_CODE, GRID_GU = T4.GRID_GU, STREET_POST_DIRECTION = QUADRANT

FROM (

SELECT T3.* FROM (
SELECT 
	LU2.VALUE_CODE AS FILE_CODE 
	,GRID2.GRID_GU
,T2.*
	FROM 
(
SELECT 
	
	T1.*
	,GRID.GRID_CODE
	,STREET.SCHOOL_YEAR
	,STREET.STREET_LOW_ADDRESS
	,STREET.STREET_NAME
	,STREET.STREET_TYPE
	,VALUE_DESCRIPTION AS STREET_TYPE_DESC
	,STREET.[STREET_POST_DIRECTION]
	,STREET.CITY AS STREET_CITY
	,STREET.STATE AS STREET_STATE
	,STREET.ZIP_5
	,STREET.STREET_GU
	FROM
            OPENROWSET (
                  'Microsoft.ACE.OLEDB.12.0', 
                 'Text;Database=\\SYNTEMPSSIS\Files\TempQuery;',
                  'SELECT * from CMPFILE.csv'
                ) AS [T1]

	LEFT JOIN 
	(SELECT * FROM 
	rev.EPC_STREET
	LEFT JOIN 
	 [APS].[LookupTable]('K12.AddressInfo','STREET_TYPE') AS LU
	 ON
	 LU.VALUE_CODE = STREET_TYPE 
	 WHERE rev.EPC_STREET.SCHOOL_YEAR = 2016
	 ) AS STREET
	ON
	STREET.STREET_LOW_ADDRESS = T1.[HOUSE NUMBER]
	AND STREET.STREET_NAME = T1.STREET
	--AND STREET.[STREET_POST_DIRECTION] = T1.QUADRANT
	AND STREET.ZIP_5 = T1.ZIPCODE
	AND STREET.SCHOOL_YEAR = 2016
	--AND T1.[STREET TYPE] = STREET.VALUE_DESCRIPTION
	
	LEFT JOIN 
	rev.EPC_GRID AS GRID
	ON
	GRID.GRID_GU = STREET.GRID_GU
	AND GRID.SCHOOL_YEAR = STREET.SCHOOL_YEAR

) AS T2
--WHERE RN> 1
LEFT JOIN 
	 [APS].[LookupTable]('K12.AddressInfo','STREET_TYPE') AS LU2
	 ON
	 LU2.VALUE_DESCRIPTION = T2.[STREET TYPE]

LEFT JOIN 
	rev.EPC_GRID AS GRID2
	ON
	GRID2.GRID_CODE = GridCode
	AND GRID2.SCHOOL_YEAR = 2016


) AS T3

WHERE
T3.CITY != STREET_CITY 
OR 
GridCode != GRID_CODE
OR 
[STREET TYPE] != STREET_TYPE_DESC
OR 
[STREET_POST_DIRECTION] != QUADRANT

) AS T4

--ORDER BY  STREET_NAME, STREET_LOW_ADDRESS

WHERE

T4.STREET_GU = rev.EPC_STREET.STREET_GU

ROLLBACK
	
REVERT
GO