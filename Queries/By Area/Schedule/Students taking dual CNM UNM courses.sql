

SELECT 
GRADE, SCHOOL_NAME, COUNT (*) AS NUMBER_OF_STUDENTS
FROM
(

SELECT 
DISTINCT SCH.SIS_NUMBER
	,CASE WHEN ENR.GRADE IS NULL THEN NONENR.GRADE ELSE ENR.GRADE END AS GRADE 
	,CASE WHEN ENR.SCHOOL_NAME IS NULL THEN NONENR.SCHOOL_NAME ELSE ENR.SCHOOL_NAME END AS SCHOOL_NAME
	/*
	PERS.LAST_NAME
	,PERS.FIRST_NAME
	,SCH.SIS_NUMBER
	,CASE WHEN ENR.GRADE IS NULL THEN NONENR.GRADE ELSE ENR.GRADE END AS GRADE
	,CASE WHEN ENR.SCHOOL_CODE IS NULL THEN NONENR.SCHOOL_CODE ELSE ENR.SCHOOL_CODE END AS SCHOOL_CODE
	,CASE WHEN ENR.SCHOOL_NAME IS NULL THEN NONENR.SCHOOL_NAME ELSE ENR.SCHOOL_NAME END AS SCHOOL_NAME
	,SCH.TERM_CODE
	,SCH.PERIOD_BEGIN
	,SCH.PERIOD_END
	,SCH.COURSE_ID
	,SCH.SECTION_ID
	,SCH.COURSE_TITLE
	,SCH.COURSE_ENTER_DATE
	,SCH.COURSE_LEAVE_DATE
	*/
	FROM
            
	APS.ScheduleDetailsAsOf('2017-05-25') AS SCH

	LEFT JOIN 
	APS.PrimaryEnrollmentDetailsAsOf(GETDATE()) AS ENR
	ON
	SCH.STUDENT_GU = ENR.STUDENT_GU
	--AND SCH.STUDENT_SCHOOL_YEAR_GU = ENR.STUDENT_SCHOOL_YEAR_GU

	LEFT JOIN 
	APS.NonPrimaryEnrollmentsAsOf(GETDATE()) AS NONENR
	ON
	NONENR.STUDENT_GU = SCH.STUDENT_GU
	AND SCH.STUDENT_SCHOOL_YEAR_GU = NONENR.STUDENT_SCHOOL_YEAR_GU

	LEFT JOIN 
	rev.REV_PERSON AS PERS
	ON
	PERS.PERSON_GU = SCH.STUDENT_GU

	WHERE
	DUAL_CREDIT = 'Y'
	OR OTHER_PROVIDER_NAME IN ('CNM', 'UNM')

) AS T2

GROUP BY 
GRADE, SCHOOL_NAME
	
ORDER BY SCHOOL_NAME, GRADE

REVERT
GO