
SELECT 
	 ENROLLMENT.SIS_NUMBER
	,ENROLLMENT.SCHOOL_CODE
	,sch.STATE_SCHOOL_CODE
	,ORG.ORGANIZATION_NAME AS SCHOOL_NAME
	,ENROLLMENT.EXCLUDE_ADA_ADM
	,MEMBER_DAYS AS DAYS_ATTENDED
	,CASE 
		WHEN PERIOD.[Total Unexcused] IS NOT NULL THEN MEMBER_DAYS - PERIOD.[Total Unexcused] 
		WHEN DAILY.[Total Unexcused] IS NOT NULL THEN MEMBER_DAYS - DAILY.[Total Unexcused] 
		ELSE MEMBER_DAYS 
	END AS DAYS_PRESENT
	,startDate AS ENTER_DATE
	,endDate AS LEAVE_DATE
	,STU.STATE_STUDENT_NUMBER
	 
  FROM 
  
  (  
 SELECT 
	startDate
	,endDate
	,SIS_NUMBER
	,SCHOOL_CODE
	,EXCLUDE_ADA_ADM
	,SUM(CAST(MEMBERDAYS AS INT)) AS MEMBER_DAYS
FROM
(
SELECT 
	MIN(ENTER_DATE) AS startDate
	,MAX(LEAVE_DATE) AS endDate
	,SIS_NUMBER
	,SCHOOL_CODE
	,EXCLUDE_ADA_ADM
	,MEMBERDAYS
FROM 
   STUDENT_SCHOOL_MEMBERDAYS_120D
WHERE
	SCHOOL_CODE != '517'

GROUP BY 
  	SIS_NUMBER
	,SCHOOL_CODE
	,EXCLUDE_ADA_ADM
	,MEMBERDAYS
) AS T1

GROUP BY 
	startDate
	,endDate
	,SIS_NUMBER
	,SCHOOL_CODE
	,EXCLUDE_ADA_ADM ) AS ENROLLMENT

  LEFT HASH JOIN 
(SELECT
			[udr].[SIS_NUMBER]
			,CAST([udr].[SCHOOL_CODE] AS VARCHAR) AS [SCHOOL_CODE]
			,SUM([udr].[Total Unexcused]) AS [Total Unexcused]
			,[o].[ORGANIZATION_NAME]

		FROM
			[APS].[PeriodAllDateRange]('20161202','20170208') AS [udr]
			
			INNER JOIN
			[rev].[EPC_SCH] AS [s]
			ON
			[udr].[SCHOOL_CODE]=[s].[SCHOOL_CODE]

			INNER JOIN
			[rev].[REV_ORGANIZATION] AS [o]
			ON
			[s].[ORGANIZATION_GU]=[o].[ORGANIZATION_GU]

		GROUP BY
			[udr].[SIS_NUMBER]
			,CAST([udr].[SCHOOL_CODE] AS VARCHAR)
			,[o].[ORGANIZATION_NAME]
		) AS PERIOD

		ON
		PERIOD.SIS_NUMBER = ENROLLMENT.SIS_NUMBER
		AND PERIOD.SCHOOL_CODE = ENROLLMENT.SCHOOL_CODE

LEFT HASH JOIN 

(SELECT
			[udr].[SIS_NUMBER]
			,CAST([udr].[SCHOOL_CODE] AS VARCHAR) AS [SCHOOL_CODE]
			,SUM([udr].[Unexcused Absence Count]) AS [Total Unexcused]
			,[o].[ORGANIZATION_NAME]
		FROM	
			[APS].[DailyAllDateRange]('20161202','20170208') AS [udr]

			INNER JOIN
			[rev].[EPC_SCH] AS [s]
			ON
			[udr].[SCHOOL_CODE]=[s].[SCHOOL_CODE]

			INNER JOIN
			[rev].[REV_ORGANIZATION] AS [o]
			ON
			[s].[ORGANIZATION_GU]=[o].[ORGANIZATION_GU]
			
		GROUP BY
			[udr].[SIS_NUMBER]
			,CAST([udr].[SCHOOL_CODE] AS VARCHAR)
			,[o].[ORGANIZATION_NAME]
) AS DAILY

ON
ENROLLMENT.SIS_NUMBER = DAILY.SIS_NUMBER
AND ENROLLMENT.SCHOOL_CODE = DAILY.SCHOOL_CODE

INNER JOIN 
rev.EPC_STU AS STU
ON
ENROLLMENT.SIS_NUMBER = STU.SIS_NUMBER

LEFT JOIN 
rev.EPC_SCH AS SCH
ON
ENROLLMENT.SCHOOL_CODE = SCH.SCHOOL_CODE

LEFT JOIN
rev.REV_ORGANIZATION AS ORG
ON
SCH.ORGANIZATION_GU = ORG.ORGANIZATION_GU


  
  

